## 文档整理
- 将文档从 `Documentation/` 迁移到 `docs-dev/`，按 `dev/features/ops` 分类。
- 为兼容历史输入新增符号链接：`doc-dev -> docs-dev`。
- 同步修复 `README.md` 与 `docs-dev/dev/Getting-Started.md` 中的文档链接。
- 新增 `DocumentationStructureTests`，覆盖 docs-dev 结构、关键文档落位与 README/Getting-Started 链接有效性。
- 为恢复测试可编译，修复 `SKIStreamingTests.swift` 中 mock tool 的 `Output` 由 `Encodable` 改为 `Codable`。
- 验证命令：`swift test --filter DocumentationStructureTests`（5/5 通过）。

## 23:14 CLI 参考仓库基线
- 目标：为 SKIntelligence 后续 CLI 设计建立长期对标参考。
- 位置：`/Users/linhey/Desktop/FlowUp-Libs/_cli-references`
- 仓库：
  - openai/codex @ `bd3bf6eda`（main）
  - badlogic/pi-mono @ `34878e7c`（main）
  - google-gemini/gemini-cli @ `5baad108d`（main）
- 说明：参考仓库放在项目外，避免污染当前库版本历史。

## 23:22 CLI 文档基线
- 新增需求规格：`docs-dev/features/CLI-Benchmark-Spec.md`
- 新增技术方案：`docs-dev/dev/CLI-Architecture-Plan.md`
- 约束：v0 先覆盖 `chat/run/config/version`，先测后实现。

## 23:59 ACP CLI 开工实现（阶段性）
- 新增模块：`SKIJSONRPC`、`SKIACP`、`SKIACPTransport`、`SKIACPClient`、`SKIACPAgent`、`SKICLI`。
- 新增可执行：`ski`（`ski acp serve` / `ski acp client connect`）。
- 当前能力：
  - 已完成 `stdio` 端到端（agent/client）基础链路。
  - 已完成 `ws client` 传输；`ws server` 预留占位并显式返回未实现。
- 测试：新增 JSON-RPC/ACP 单测并通过（定向测试）。

## 00:10 ACP WebSocket Server Transport 完成
- 决策：在 `SKIACPTransport` 中将 `WebSocketServerTransport` 从占位改为可用实现，基于 `Network`（`NWListener + NWConnection`）支持本地 ws 服务端模式。
- 范围：保持单连接本地模式；`stdio` 流程保持不变。
- CLI 变更：`ski acp serve --transport ws --listen <host:port>` 现可直接跑 ACP agent，并复用与 stdio 相同的请求分发逻辑。
- 测试：新增 `ACPWebSocketRoundtripTests`，覆盖 ws server/client + ACP agent/client 的 `initialize -> session/new -> session/prompt` 回路。
- 风险结论：当前不含多客户端复用与鉴权，仅面向本地开发模式。

## 00:14 ACP 第二阶段（超时/取消/TTL）完成
- `ACPAgentService` 新增 `Options`，支持 `promptTimeoutNanoseconds` 与 `sessionTTLNanos`。
- 错误映射改进：`methodNotFound -> -32601`，`invalidParams/sessionNotFound -> -32602`，`promptTimedOut/未知错误 -> -32603`。
- `ACPClientService` 新增 `requestTimeoutNanoseconds` 与结构化错误 `ACPClientServiceError`（`requestTimeout`、`rpcError`）。
- CLI 新增参数：`acp serve --prompt-timeout-ms --session-ttl-ms --log-level`，`acp client connect --request-timeout-ms --log-level`。
- 测试新增并通过：取消、超时、TTL 过期、method not found、client request timeout。

## 00:35 ACP 第三阶段（传输韧性）完成
- `WebSocketClientTransport` 新增 `Options`：心跳间隔、重连策略、发送背压阈值；支持自动心跳与失败后退避重连。
- `WebSocketServerTransport` 新增 `Options.maxInFlightSends`，发送路径接入背压门控。
- 新增基础组件：`ACPTransportRetryPolicy`、`ACPTransportBackpressureGate`。
- CLI 增强：
  - `acp serve` 增加 `--max-in-flight-sends`
  - `acp client connect` 增加 `--ws-heartbeat-ms --ws-reconnect-attempts --ws-reconnect-base-delay-ms --max-in-flight-sends`
- 新增测试：
  - `ACPTransportResilienceTests`（退避策略 + 背压阻塞）
  - `ACPTransportBaselineTests`（JSON-RPC 编解码基线）
- 基线数据：`ACPTransportBaselineTests` 2000 次编解码平均约 `0.131s`（本机）。

## 00:46 第四阶段（重连回归 + 协议兼容矩阵）完成
- 新增 `ACPWebSocketReconnectTests`：真实 ws 重连回归场景，默认 `XCTSkip`（需 `RUN_LIVE_WS_RECONNECT_TESTS=1` 手动启用），避免 CI 环境长时间阻塞。
- `JSONRPCCodecTests` 补充兼容性边界：
  - 非法 envelope（array）应报 `invalidEnvelope`
  - 非法 `id` 类型应报 `invalidEnvelope`
  - line framer 应容忍首尾空白
- 风险结论：真实网络重连端到端在当前环境存在不稳定阻塞，已改为 opt-in live integration test；主线由退避/背压与 ws roundtrip 测试覆盖。

## 00:49 JSON-RPC 解码校验增强
- `JSONRPCCodec.decode` 新增版本预校验：当 `jsonrpc` 字段存在且不为 `2.0` 时返回 `invalidVersion`。
- `response` envelope 增加结构约束：`result/error` 必须二选一，否则返回 `invalidEnvelope`。
- 回归结果：`ACP + Transport + JSONRPC` 定向测试通过，`ACPWebSocketReconnectTests` 仍默认 skip（opt-in live）。

## 00:52 协议边界与错误码矩阵补强
- `JSONRPCCodecTests` 新增：
  - 空白行拒绝（`invalidEnvelope`）
  - 大消息 line framer 回环（512KB）
- `ACPAgentService` 错误映射更新：
  - `ACPCodec` 参数缺失/解码失败、`DecodingError` -> `-32602 invalidParams`
  - 保留 `methodNotFound -> -32601`、未知异常 -> `-32603`
- 定向回归：`ACPAgentServiceTests + JSONRPCCodecTests + 传输韧性/基线/ws roundtrip` 全通过（live reconnect 继续 opt-in skip）。

## 00:56 并发防御与客户端容错补强
- `ACPAgentService` 新增 session 级并发防御：同一 `sessionId` 存在运行中 prompt 时，第二个 `session/prompt` 直接返回 `-32602 invalidParams`。
- 修复 timeout 竞态：超时与取消竞争时，超时稳定映射为 `-32603`，避免偶发落入 `cancelled` 成功响应。
- `ACPClientServiceTests` 新增重复/未知 response 容错场景：重复 `id` 响应与未知 `id` 响应不应破坏后续调用。

## 00:58 客户端并发压力测试补齐
- 新增 `ACPClientServiceTests.testConcurrentRequestsHandleOutOfOrderResponses`：
  - 构造乱序/延迟返回 + 未知 `id` 噪声 response 的传输层模拟器
  - 并发 40 个 `session/new` 请求，验证全部成功且 `sessionId` 唯一
- 风险结论：当前 `ACPClientService` 的 pending map 对乱序/噪声包可正确容错；live ws 重连仍维持 opt-in。

## 01:00 并发状态清理与取消幂等
- `ACPClientService` 增加测试观测口：
  - `_testingPendingCount()`
  - `_testingTimeoutTaskCount()`
- 压测后断言 `pending == 0` 且 `timeoutTasks == 0`，确认并发完成后无残留状态。
- `ACPAgentService` 新增 `testCancelIsIdempotent`，重复 cancel 不影响结果一致性（仍返回 `cancelled`）。

## 01:03 close 语义一致性补齐
- `ACPClientServiceTests` 新增：
  - `testCloseCancelsInFlightRequestWithEOF`
  - `testCloseCancelsMultipleInFlightRequestsWithEOF`
- 结论：`client.close()` 会稳定把 in-flight 请求收敛为 `ACPTransportError.eof`，并清空 pending/timeout 内部状态。

## 01:05 close vs timeout 竞态优先级确认
- 新增测试：
  - `testCloseBeforeTimeoutPrefersEOF`
  - `testTimeoutBeforeCloseReturnsRequestTimeout`
- 结论：关闭与超时并发时，先发生事件决定错误类型（EOF 或 requestTimeout），行为可预测且无双重恢复。

## 01:07 close 幂等与关闭后语义
- `ACPClientServiceTests` 新增：
  - `testCloseIsIdempotent`
  - `testCallAfterCloseReturnsNotConnected`
- 结论：
  - `client.close()` 可重复调用，内部状态保持干净；
  - 关闭后再次调用 API，稳定返回 `ACPTransportError.notConnected`。

## 01:10 交互顺序与生命周期边界
- `ACPAgentServiceTests` 新增：
  - `testCancelledPromptDoesNotEmitSessionUpdate`
  - `testTimeoutPromptDoesNotEmitSessionUpdate`
- `ACPClientServiceTests` 新增：
  - `testSessionUpdateDeliveredBeforePromptReturn`
- 结论：
  - prompt 的取消/超时路径不再产生多余 update 通知；
  - 正常路径中 update 先于 prompt 结果交付，客户端可稳定构建流式 UI。

## 01:15 request-id 与长时稳定性基线
- `ACPClientServiceTests` 新增：
  - `testConcurrentRequestIDsAreUniqueAndContiguous`（并发 200）
  - `testLongRunSequentialRequestsKeepInternalStateClean`（顺序 1000 次）
- 结论：
  - request id 分配在并发场景下保持唯一且连续；
  - 长时运行后 pending/timeoutTasks 均归零，无状态泄漏迹象。
