## SKIntelligence 技能落地（方法型）
- 决策：新增 `skills/skintelligence`，定位“全库方法手册 + 可执行脚本”，避免把 docs-dev 全量镜像进技能。
- 边界：落实单向引用规则，仅允许 `docs-dev -> skills`，技能内禁止反向引用 `docs-dev`。
- 实现：
  - 新增 `skills/skintelligence/SKILL.md`（触发词覆盖 ACP/CLI/回归/联调/测试门禁）。
  - 新增脚本：
    - `skills/skintelligence/scripts/run_acp_regression.sh`
    - `skills/skintelligence/scripts/run_targeted_tests.sh`
    - `skills/skintelligence/scripts/run_codex_connect_smoke.sh`
  - 新增方法参考：
    - `skills/skintelligence/references/workflows.md`
    - `skills/skintelligence/references/commands.md`
    - `skills/skintelligence/references/troubleshooting.md`
  - 新增 docs 入口：`docs-dev/dev/Skills-Index.md`，并在 `docs-dev/dev/Getting-Started.md` 增加索引链接。
- 验证：
  - 反向引用检查：`rg -n "docs-dev/" skills/skintelligence -S` 无结果。
  - 技能校验：`quick_validate.py` 通过。
  - 打包：生成 `skills/dist/skintelligence.skill`。
  - 脚本代表性执行：`skills/skintelligence/scripts/run_targeted_tests.sh SKICLITests` 通过（19/19）。
- 风险：本地 `quick_validate/package_skill` 依赖 `pyyaml`，通过仓库内 `.local/skill-venv` 解决；如在新环境复现需先准备该依赖。

## SKIntelligence 技能补强（全库模块覆盖）
- 决策：在已有 ACP/CLI 流程基础上补齐非 ACP 模块（Streaming/Memory/MCP/TextIndex）的方法入口，确保“全库开发助手”名副其实。
- 新增：
  - 脚本：`skills/skintelligence/scripts/run_library_smoke.sh`（覆盖 `SKIStreamingTests/SKIMemoryTests/SKIMCPIntegrationTests/SKITextIndexTests`）。
  - 参考：`skills/skintelligence/references/module-playbooks.md`（四大模块方法手册）。
  - 更新：`skills/skintelligence/SKILL.md` 与 `docs-dev/dev/Skills-Index.md`。
- 验证：
  - `quick_validate.py` 通过。
  - 重新打包 `skills/dist/skintelligence.skill` 成功。
  - `run_library_smoke.sh` 通过（56 tests, 0 failures）。
  - 反向引用守卫：`rg -n "docs-dev/" skills/skintelligence -S` 无命中。

## 技能迁移继续推进（docs-dev 单向引用补强）
- 决策：在不迁移架构/规格正文的前提下，将高频执行入口从 `docs-dev` 指向技能脚本，减少“猜命令”。
- 变更：
  - `docs-dev/dev/Codex-ACP-Runbook.md` 增加技能入口（SKILL + ACP 回归/smoke 脚本）。
  - `docs-dev/dev/testing-strategy.md` 增加技能测试入口（targeted/library smoke 脚本）。
- 验证：
  - 技能校验与打包通过；
  - `run_library_smoke.sh` 回归通过（56/56）；
  - 反向引用守卫保持通过（skills 内无 `docs-dev/` 引用）。

## 技能治理补强：单向引用边界守卫脚本
- 新增：`skills/skintelligence/scripts/check_skill_boundary.sh`。
- 规则：阻断 `skills/skintelligence` 内对 `docs-dev/` 的反向引用；并检查 `docs-dev` 是否至少存在一处指向 `skills/skintelligence` 的正向引用。
- 修正：首版误报（脚本扫描到自身字符串）已修复，改为过滤 `scripts/check_skill_boundary.sh` 行后判定。
- 验证：边界脚本执行通过，技能可重新打包。

## ChatResponseBody OpenAI-compatible 兼容修复（单模式输出）
- 决策：保持对外单一业务模型 `ChatResponseBody`，兼容逻辑收敛到解码层（内部 Raw + normalize），不引入双轨调用或长期 fallback 分叉。
- 关键实现：
  - `content` 支持 `string/null/[]/[{type,text}]`，数组文本片段按顺序合并。
  - `tool_calls` 支持 `missing/null/[]/部分坏项`，坏项局部丢弃，空结果归一为 `nil`。
  - `function.arguments` 支持 `string/object/non-object JSON`。
    - `string`：保留原 `argumentsRaw`，可解析对象时填充 `arguments`。
    - `object`：填充 `arguments`，并生成 canonical `argumentsRaw`（compact + sortedKeys）。
    - 非对象 JSON：保留 canonical `argumentsRaw`，`arguments=nil`。
  - `OpenAIClient` decode 失败增强诊断：保留 `DecodingError` 语义并补充 `codingPath/model/url/responseSnippet`，且对 `api_key/authorization/token` 进行脱敏。
- 测试：
  - 新增 `ChatResponseBodyCompatibilityTests`（含最小 deterministic 随机稳健性用例）。
  - 新增 `OpenAIClientDecodingDiagnosticsTests`。
  - 回归 `SKIAgentSessionTests` 与 `SKIStreamingTests` 通过。

## 官方文档真实 fixture 接入（OpenAI / DashScope / DeepSeek）
- 决策：兼容回归改为“手写样例 + 官方文档 fixture”双轨验证，降低主观构造样例偏差。
- 新增 fixture：
  - `Tests/SKIntelligenceTests/Fixtures/chat-response-compat/openai_cookbook_tool_call_response.json`
  - `Tests/SKIntelligenceTests/Fixtures/chat-response-compat/dashscope_http_chat_response.json`
  - `Tests/SKIntelligenceTests/Fixtures/chat-response-compat/deepseek_api_schema_tool_call_response.json`
  - `Tests/SKIntelligenceTests/Fixtures/chat-response-compat/README.md`（来源追溯）
- 来源：
  - OpenAI Cookbook `how_to_call_functions_with_chat_models`
  - 阿里云 DashScope OpenAI 兼容文档（HTTP 响应示例）
  - DeepSeek Create Chat Completion API 文档（schema/example 字段）
- 测试更新：
  - `ChatResponseBodyCompatibilityTests/testDecodeOfficialProviderFixtures` 改为读取 bundle fixture 并断言关键字段。
  - `swift test --filter "ChatResponseBodyCompatibilityTests|OpenAIClientDecodingDiagnosticsTests"` 通过。

## 版本发布：1.3.17
- 发布动作：
  - 提交：`d0210d1`（兼容性修复 + 官方 fixture + 诊断增强 + spec/release 文档）
  - tag：`1.3.17`
  - push：`origin/main` 与 `origin/1.3.17`
  - GitHub Release：https://github.com/linhay/SKIntelligence/releases/tag/1.3.17
- 协作同步：
  - issue #1 更新了变更摘要和使用示例。

## SKIJSONRPC 移除并切换 STJSON 1.4.9
- 决策：不再使用 `SKIJSONRPC` 模块，协议层统一迁移到 `STJSON`（1.4.9）。
- 实现：
  - 删除 `Sources/SKIJSONRPC` 源码目录。
  - `Package.swift` 删除 `SKIJSONRPC` product/target，`SKIACP` 改为依赖 `STJSON`，`SKIACPTransport` 改依赖 `SKIACP`。
  - 新增 `Sources/SKIACP/JSONRPCCompat.swift` 与 `Sources/SKIACP/JSONValue.swift`：保持现有 ACP 调用接口不变，底层编解码与规范校验委托 STJSON JSONRPC。
  - 全仓 `import SKIJSONRPC` 替换为 `import SKIACP`（或在 `SKIACP` 内移除）。
- 验证：
  - `swift test --filter JSONRPCCodecTests` 通过（13/13）。
  - `swift test --filter 'ACPTransport|ACPClientServiceTests|ACPAgentServiceTests|ACPDomainE2EMatrixTests'` 通过（93/93）。
  - 全量 `swift test` 运行完成，但存在 3 个与迁移无关失败：
    - `ACPUpstreamWatchScriptTests/testWatchReportIncludesPriorityItemsAndSupportsRepoOverride`（同一用例内 2 条断言失败）
    - `SKICLIProcessTests/testClientConnectViaWSServeProcessMultiplePromptsReuseSameSession`

## STJSON 收敛迁移收尾（JSONRPC/JSONValue 重复定义清理）
- 结论：`SKIACP` 侧不再重复定义 `JSONRPCID / JSONRPCVersion / JSONRPCRequest / JSONRPCResponse / JSONValue`，协议模型统一使用 `STJSON.JSONRPC` + `AnyCodable`。
- 关键改动：
  - 删除本地重复 JSON 值模型：`Sources/SKIACP/JSONValue.swift`。
  - `Sources/SKIACP/JSONRPCCompat.swift` 收敛为兼容层（仅保留 codec/framer 与少量桥接扩展），不再引入重复协议实体定义。
  - 新增 `Sources/SKIACP/AnyCodable+JSONValueCompat.swift`，补齐旧调用所需读写便捷能力，避免继续依赖本地 JSONValue 枚举。
  - ACP 相关模块与测试已全部切换到 `STJSON.JSONRPC.*` 与 `AnyCodable` 路径。
- 验证：
  - 全量测试通过：`swift test --package-path .` => `420` tests, `0` failures, `1` skipped（2026-02-28）。
  - 代码检索确认：`Sources/SKIACP*` 中无 `JSONValue` 与 `JSONRPC*` 重复定义残留。

## STJSON AnyCodable 兼容层收敛（去掉 JSONValueCompat 扩展）
- 决策：不再保留 `Sources/SKIACP/AnyCodable+JSONValueCompat.swift` 这类“模拟 JSONValue API”的扩展（`AnyCodable.object/string/...` 与 `objectValue/stringValue/...`）。
- 实施：
  - 删除 `Sources/SKIACP/AnyCodable+JSONValueCompat.swift`。
  - ACP 动态字段读取改为 `AnyCodable.decode(to:)` 或 `value` 显式解包；必要处补数值统一转换函数。
  - JSONRPC 请求/响应参数构造改为 `AnyCodable(...)`，不再使用兼容静态构造器。
- 影响文件（核心）：
  - `Sources/SKIACP/JSONRPCCompat.swift`
  - `Sources/SKIACP/ACPModels.swift`
  - `Sources/SKIACPTransport/WebSocketServerTransport.swift`
  - `Sources/SKIACPAgent/PermissionPolicy/ACPToolCallFingerprint.swift`
  - 多个 ACP 相关测试文件同步迁移。
- 验证：`swift test --package-path .` 通过，`420` passed，`0` failed，`1` skipped。
