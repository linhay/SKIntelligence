# 2026-02-27

## ACP 回归套件 summary 演进（schema v4）
- 决策：在 `scripts/acp_regression_suite.sh` 的 summary 中新增 `alerts` 与 `summaryCompact`，用于下游消费降本。
- 实现：
  - `alerts`：输出标准化告警对象数组（`required_failure` / `optional_warn` / `optional_skipped` / `summary_inconsistent`）。
  - `summaryCompact`：输出最小聚合视图（`overallOutcome`、`ciRecommendation`、`failedStagesCount`、`nonPassStagesCount` 等）。
  - `schemaVersion`：`3 -> 4`。
- 验证：
  - `RUN_CODEX_PROBES=0 ACP_SUITE_SUMMARY_JSON=.local/acp-summary-latest.json ./scripts/acp_regression_suite.sh`
  - `jq '{schemaVersion, alerts, summaryCompact}' .local/acp-summary-latest.json`
- 风险结论：新增字段为向后兼容扩展；旧消费端不读取新字段不受影响，新消费端需先校验 `schemaVersion`。

## ACP 回归套件 summary 告警聚合增强
- 决策：在已有 `alerts` 上新增机器判定友好字段 `alertCounts` 与 `hasBlockingAlerts`。
- 实现：
  - `alertCounts`：按 `required_failure/optional_warn/optional_skipped/summary_inconsistent` 计数。
  - `hasBlockingAlerts`：当存在 `required_failure` 或 `summary_inconsistent` 时为 `true`。
- 验证：
  - `RUN_CODEX_PROBES=0 ACP_SUITE_SUMMARY_JSON=.local/acp-summary-latest.json ./scripts/acp_regression_suite.sh`
  - `jq '{alertCounts, hasBlockingAlerts, alerts}' .local/acp-summary-latest.json`

## ACP 回归套件 codex 探针聚合
- 决策：为联调增加 `codexProbes` 聚合对象，避免下游分别读取多个 stage 字段。
- 实现：
  - `enabled`（是否启用探针）与 `strict`（是否严格模式）。
  - `permissionProbeStatus`、`multiturnProbeStatus`（两个探针阶段状态）。
  - `nonPassCount`（两个探针中非 `pass` 的数量）。
- 验证：
  - `RUN_CODEX_PROBES=0 ACP_SUITE_SUMMARY_JSON=.local/acp-summary-latest.json ./scripts/acp_regression_suite.sh`
  - `jq '{codexProbes, probeMode, runCodexProbes, strictCodexProbes}' .local/acp-summary-latest.json`

## ACP 回归套件状态分桶与质量门禁视图
- BDD 场景：下游联调看板需要直接消费“按状态分桶的 stage 集合”和“质量门禁对象”，不再本地二次聚合。
- 红灯：
  - `jq -e '(.stageStatusBuckets | type == "object") and (.qualityGate | type == "object")' .local/acp-summary-latest.json`（新增前失败）
- 绿灯：
  - 新增 `passStages`、`stageStatusBuckets(pass/fail/warn/skipped/nonPass)`。
  - 新增 `qualityGate(blocked/degraded/clean/recommendation/reason)`。
  - 串行验证：`jq -e '(.stageStatusBuckets | type == "object") and (.qualityGate | type == "object") and (.passStages | type == "array")' .local/acp-summary-latest.json`。

## ACP 回归套件 timingStats 聚合
- BDD 场景：联调时需要快速定位耗时瓶颈阶段，避免每次手动遍历 `stages[*].durationSeconds`。
- 红灯：
  - `jq -e '(.timingStats | type == "object") and (.timingStats.maxDurationStage | type == "string")' .local/acp-summary-latest.json`（新增前失败）。
- 绿灯：
  - 新增 `timingStats`：`suiteDurationSeconds`、`sumStageDurations`、`maxDurationStage/maxDurationSeconds`、`minDurationStage/minDurationSeconds`。
  - 验证：`jq '{timingStats}' .local/acp-summary-latest.json`。

## schemaVersion 升级到 5
- 决策：连续扩展 summary 字段后升级版本，避免下游消费端误判能力边界。
- 验证：
  - `RUN_CODEX_PROBES=0 ACP_SUITE_SUMMARY_JSON=.local/acp-summary-latest.json ./scripts/acp_regression_suite.sh`
  - `jq -e '.schemaVersion == "5"' .local/acp-summary-latest.json`

## compatV4 兼容视图
- BDD 场景：部分旧消费端尚未迁移到 v5 扩展字段，需要稳定子对象承载核心结论。
- 红灯：
  - `jq -e '(.compatV4 | type == "object") and (.compatV4.requiredPassed | type == "boolean")' .local/acp-summary-latest.json`（新增前失败）。
- 绿灯：
  - 新增 `compatV4`（`requiredPassed/ciRecommendation/overallOutcome/overallOutcomeRank/failedStages/nonPassStages/warnStages/skippedStages/requiredFailedStages/probeMode`）。
  - 验证：`jq '{schemaVersion, compatV4}' .local/acp-summary-latest.json`。

## consumerHints 接入提示
- BDD 场景：联调方希望快速知道“应该读哪些字段”，避免每次人工对照 runbook。
- 红灯：
  - `jq -e '(.consumerHints | type == "object") and (.consumerHints.primaryGatePath | type == "string")' .local/acp-summary-latest.json`（新增前失败）。
- 绿灯：
  - 新增 `consumerHints`，提供 `primaryGatePath/primaryOutcomePath/blockingSignalPath/stageBucketsPath/compatPath/schemaVersionPath`。
  - 验证：`jq '{schemaVersion, consumerHints}' .local/acp-summary-latest.json`。

## summaryIntegrity 可用性汇总
- BDD 场景：消费端需要先判断 summary 是否可信，再决定是否继续做规则判定。
- 红灯：
  - `jq -e '(.summaryIntegrity | type == "object") and (.summaryIntegrity.ok | type == "boolean")' .local/acp-summary-latest.json`（新增前失败）。
- 绿灯：
  - 新增 `summaryIntegrity`：`countsConsistent/hasSummaryHash/hasRunId/hasStageLogs/ok`。
  - 验证：`jq '{summaryIntegrity}' .local/acp-summary-latest.json`。

## drilldown 首个问题点指引
- BDD 场景：联调排障希望直接拿到“第一个非通过阶段”与日志位置，减少手动遍历。
- 红灯：
  - `jq -e '(.drilldown | type == "object") and (.drilldown.firstNonPassStage | type == "string")' .local/acp-summary-latest.json`（新增前失败）。
- 绿灯：
  - 新增 `drilldown`：`firstNonPassStage/firstNonPassStatus/firstNonPassLogPath`。
  - 验证：`jq '{drilldown, nonPassStages}' .local/acp-summary-latest.json`。

## decisionMatrix 判定矩阵
- BDD 场景：联调/CI 需要结构化的“推荐动作 + 原因类别”，减少文案解析。
- 红灯：
  - `jq -e '(.decisionMatrix | type == "object") and (.decisionMatrix.blockingReasons | type == "array")' .local/acp-summary-latest.json`（新增前失败）。
- 绿灯：
  - 新增 `decisionMatrix`：`recommendation/reason/blockingReasons/warningReasons`。
  - 验证：`jq '{decisionMatrix, ciRecommendation, resultReason}' .local/acp-summary-latest.json`。

## executionMode 运行模式语义化
- BDD 场景：联调看板需要直接显示“当前回归模式”，避免根据多个开关字段推导。
- 红灯：
  - `jq -e '(.executionMode | type == "object") and (.executionMode.mode | type == "string")' .local/acp-summary-latest.json`（新增前失败）。
- 绿灯：
  - 新增 `executionMode`：`mode(required_only/full_non_strict/full_strict)`、`description`、`probeMode`。
  - 验证：`jq '{executionMode, runCodexProbes, strictCodexProbes}' .local/acp-summary-latest.json`。
