# 2026-02-27

## ACP 回归套件 summary 演进（schema v4）
- 决策：在 `scripts/acp_regression_suite.sh` 的 summary 中新增 `alerts` 与 `summaryCompact`，用于下游消费降本。
- 实现：
  - `alerts`：输出标准化告警对象数组（`required_failure` / `optional_warn` / `optional_skipped` / `summary_inconsistent`）。
  - `summaryCompact`：输出最小聚合视图（`overallOutcome`、`ciRecommendation`、`failedStagesCount`、`nonPassStagesCount` 等）。
  - `schemaVersion`：`3 -> 4`。
- 验证：
  - `RUN_CODEX_PROBES=0 ACP_SUITE_SUMMARY_JSON=.local/acp-summary-latest.json ./scripts/acp_regression_suite.sh`
  - `jq '{schemaVersion, alerts, summaryCompact}' .local/acp-summary-latest.json`
- 风险结论：新增字段为向后兼容扩展；旧消费端不读取新字段不受影响，新消费端需先校验 `schemaVersion`。

## ACP 回归套件 summary 告警聚合增强
- 决策：在已有 `alerts` 上新增机器判定友好字段 `alertCounts` 与 `hasBlockingAlerts`。
- 实现：
  - `alertCounts`：按 `required_failure/optional_warn/optional_skipped/summary_inconsistent` 计数。
  - `hasBlockingAlerts`：当存在 `required_failure` 或 `summary_inconsistent` 时为 `true`。
- 验证：
  - `RUN_CODEX_PROBES=0 ACP_SUITE_SUMMARY_JSON=.local/acp-summary-latest.json ./scripts/acp_regression_suite.sh`
  - `jq '{alertCounts, hasBlockingAlerts, alerts}' .local/acp-summary-latest.json`

## ACP 回归套件 codex 探针聚合
- 决策：为联调增加 `codexProbes` 聚合对象，避免下游分别读取多个 stage 字段。
- 实现：
  - `enabled`（是否启用探针）与 `strict`（是否严格模式）。
  - `permissionProbeStatus`、`multiturnProbeStatus`（两个探针阶段状态）。
  - `nonPassCount`（两个探针中非 `pass` 的数量）。
- 验证：
  - `RUN_CODEX_PROBES=0 ACP_SUITE_SUMMARY_JSON=.local/acp-summary-latest.json ./scripts/acp_regression_suite.sh`
  - `jq '{codexProbes, probeMode, runCodexProbes, strictCodexProbes}' .local/acp-summary-latest.json`
