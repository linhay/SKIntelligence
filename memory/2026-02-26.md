## 2026-02-26 外部参考仓整理
- 决策：建立统一长期参考入口目录 `External/references`，通过稳定命名的符号链接访问外部仓。
- Canonical 入口：`acp-spec`、`acp-kotlin-sdk`、`acp-kotlin-sdk-jetbrains`、`pi-mono`。
- 风险控制：暂不删除历史重复克隆目录，仅在 `External/references/README.md` 标注重复关系，避免破坏既有脚本路径。
- 调整：对 `External/` 进行去重整理。将重复克隆目录 `agentclientprotocol-spec`、`agentclientprotocol-kotlin-sdk` 迁移到 `External/_archive/`，并在原路径改为软链接指向 canonical 仓。
- 新增：`External/README.md` 作为外部参考仓结构与更新入口说明。
- 调整：按要求将 `External` 更名为 `references`，并移除目录内所有软链接；`references` 下仅保留真实项目目录。
- 里程碑：完成 Codex 通过 ACP 适配器（`@zed-industries/codex-acp`）的最小可用链路联调，`initialize + session/new + session/prompt` 成功返回 `prompt_result`。
- 关键修复：JSON-RPC 编码默认会把 `/` 转义为 `\\/`，导致 `codex-acp` Rust 侧出现 `expected a borrowed string` 并使 `session/new` 超时。已在 `JSONRPCCodec` 中启用 `.withoutEscapingSlashes`。
- 覆盖：新增 JSONRPC 编码测试，验证 method 字段不会被转义；并补充 Codex ACP 规格与运行手册文档。
- 联调增强：新增 `scripts/codex_acp_smoke.sh`，用于批量验证 `ski -> codex-acp` 最小链路；本地验证 `3/3` 成功。
- 边界结论：`--session-id` 在 `connect --transport stdio` 跨进程复用会失败（`Resource not found`），属于进程生命周期边界。
- 观测结论：`--permission-decision` 只在收到 ACP 权限请求时生效；对 codex-acp 某些路径可能无显著影响。
## ACP 联调增量（多轮与权限，2026-02-26 23:05）
- 新增 `acp client connect*` 多 `--prompt` 能力：单连接内顺序执行多轮 `session/prompt`，输出多条 `prompt_result`。
- 关键边界：`session-id` 不能跨“不同 client 连接”复用（ws 亦然），需在单连接内复用会话。
- 本地联调结论：
  - `serve --transport ws --permission-mode required` 下，`--permission-decision deny` 可稳定得到 `stopReason=cancelled`。
  - 本地 `serve --transport stdio` 多轮 prompt 当前存在第二轮超时限制，保留单轮验收。
- 新增脚本：`scripts/codex_acp_multiturn_smoke.sh`（codex-acp 多轮烟测）。
- 新增/更新测试：
  - `SKICLIProcessTests.testClientConnectViaWSServeProcessMultiplePromptsReuseSameSession`
  - `SKICLIProcessTests.testClientConnectViaWSRequiredPermissionDenyReturnsCancelled`
- `scripts/codex_acp_multiturn_smoke.sh` prompt 调整为短回复，已实测通过：`PASS ... prompt_result_count=2`。
- 新增 `scripts/acp_ws_permission_matrix.sh`：本地 ws(required) 权限矩阵一键联调，校验 allow=end_turn、deny=cancelled。
- 新增进程测试 `testClientConnectViaWSRequiredPermissionAllowReturnsEndTurn`，与 deny 用例组成权限分支回归闭环。
- 客户端新增权限请求计数日志：stderr 输出 `[SKI] ACP client permission requests=<N>`，用于联调时判定 `deny/allow` 是否进入 ACP 权限回调。
- `codex-acp` 实测（prompt: 执行 `date +%s`，`permission-decision=deny`）结果：`stopReason=end_turn` 且 `permission requests=0`，确认该路径未走 ACP `request_permission`。
- 新增 `scripts/codex_acp_permission_probe.sh`：一键对比 codex-acp 的 allow/deny，并输出 `permission_requests` 与 `stop_reason`。
- 新增测试 `testClientConnectViaWSDisabledPermissionReportsZeroRequests`，验证 permission disabled 下客户端计数为 0 且仍可 `end_turn`。
- 实测探针：allow/deny 均为 `permission_requests=0 stop_reason=end_turn`。
- 纠正结论：本地 `acp serve --transport ws` 在同一服务进程生命周期内支持跨连接 `--session-id` 复用（之前联调结论已过期）。
- 新增测试 `testClientConnectViaWSReusingSessionIDAcrossConnectionsSucceeds`。
- 新增脚本 `scripts/acp_ws_session_reuse_probe.sh`，可一键验证 ws session 复用。
- 新增 `stdio` 边界回归：`testClientConnectViaStdioReusingSessionIDAcrossConnectionsFails`。
- 新增脚本 `scripts/acp_stdio_session_reuse_probe.sh`，验证 stdio 跨连接复用 session-id 预期失败（exit=4）。
- 实测脚本通过：`PASS expected_failure_exit=4 ...`。
- 新增一键联调套件 `scripts/acp_regression_suite.sh`，串联 ws 权限矩阵、ws session 复用、stdio session 失败边界。
- 套件已实测通过：`[suite] PASS`。
- 支持可选附加 codex 探针：`RUN_CODEX_PROBES=1 ./scripts/acp_regression_suite.sh`。
- 新增参数边界回归 `testClientConnectRejectsMissingPrompt`：未传 `--prompt` 时返回 exit=2 和明确错误。
- 运行 `RUN_CODEX_PROBES=1 ./scripts/acp_regression_suite.sh` 全套通过：
  - ws 权限矩阵 PASS
  - ws session 复用 PASS
  - stdio session 失败边界 PASS
  - codex permission probe: allow/deny 均 `permission_requests=0 stop_reason=end_turn`
- 新增 `connect/connect-stdio/connect-ws` 缺省 `--prompt` 参数回归（3 条），统一要求 exit=2 + 明确错误信息。
- 复跑 `./scripts/acp_regression_suite.sh` 通过，关键 ACP 边界无回归。
- 新增 ws 无效 session-id 回归：`testClientConnectViaWSWithNonexistentSessionIDFails`（预期 exit=4）。
- runbook 补充：ws 存在 session-id 时可复用；不存在 session-id 时应 upstream failure。
- 新增 `--session-id` 空值参数回归（ws 子命令与通用 ws）：
  - `testClientConnectWSRejectsEmptySessionID`
  - `testClientConnectGenericWSRejectsEmptySessionID`
- 3 条 empty-session-id 回归均通过（exit=2 + 明确错误）。
- 新增缺关键参数回归：
  - `testClientConnectStdioRejectsMissingCmd`
  - `testClientConnectWSRejectsMissingEndpoint`
- 两条均验证 exit=2 与明确错误提示，已通过。
- 新增 `connect-stdio/connect-ws` 的负超时参数回归：
  - `testClientConnectStdioRejectsNegativeRequestTimeout`
  - `testClientConnectWSRejectsNegativeRequestTimeout`
- 复跑 `./scripts/acp_regression_suite.sh` 通过。
- 新增 `connect-ws` ws 专属参数边界回归（5 条）：heartbeat/reconnect-attempts/reconnect-base-delay/request-timeout 负值与 max-in-flight-sends=0。
- 5 条用例全部通过，均为 exit=2 + 对应参数错误提示。
- 新增 `acp client connect --transport ws` 参数边界回归（4 条）：heartbeat/reconnect-attempts/reconnect-base-delay 负值与 max-in-flight-sends=0。
- 新增 4 条用例全部通过，确保 generic connect 与 connect-ws 子命令参数校验一致。
- `scripts/acp_regression_suite.sh` 扩展 codex 可选阶段：`RUN_CODEX_PROBES=1` 时新增 `codex_acp_multiturn_smoke.sh`。
- 为 codex 两个可选阶段增加一次自动重试，避免瞬时波动引发整套误报失败；已实测全套 PASS。
- 补齐 generic connect 在 `transport=stdio` 下 ws-only 参数错误优先级回归（3 条）：
  - reconnect-attempts=-1 / reconnect-base-delay-ms=-1 / max-in-flight-sends=0
  - 统一验证先报 “only valid for ws transport”，不落入范围错误提示。
- 新增 `serve` 作用域优先级回归（2 条）并按 TDD 修复：
  - `transport=stdio + --max-in-flight-sends=0` 优先报 ws-only 作用域错误。
  - `permission-mode=disabled + --permission-timeout-ms=-1` 优先报 permission-mode 作用域错误。
- 调整 `ACPServeCommand.run()` 校验顺序后转绿，且 `./scripts/acp_regression_suite.sh` 复跑通过。
- 新增作用域优先级回归（2 条）：
  - `client connect transport=stdio + --endpoint invalid` 仍优先报 ws-only 作用域错误。
  - `serve transport=stdio + --listen invalid` 仍优先报 ws-only 作用域错误。
- 两条新增回归通过，且 `./scripts/acp_regression_suite.sh` 复跑通过。
- 补齐 `serve` 负值参数边界回归（3 条）：
  - `--prompt-timeout-ms=-1`
  - `--session-ttl-ms=-1`
  - `--permission-timeout-ms=-1`（在 permissive 模式）
- 三条用例通过并复跑 `./scripts/acp_regression_suite.sh` 通过。
- 修复 `scripts/acp_regression_suite.sh` 中 `run_with_retry` 退出码采集 bug（此前可能出现“failed with exit=0”假日志）。
- 复跑 `RUN_CODEX_PROBES=1 ./scripts/acp_regression_suite.sh`：5 段全部 PASS，日志恢复正确。
- 补齐 `serve` 在 `transport=ws` 下的 permission-timeout 禁用策略回归：
  - `permission-mode=disabled + --permission-timeout-ms=1` 必须直接报作用域错误。
- 新增用例通过，并复跑 `RUN_CODEX_PROBES=1 ./scripts/acp_regression_suite.sh` 全部 PASS。
- 补齐 `serve ws` 作用域优先级回归：
  - `permission-mode=disabled + --permission-timeout-ms=-1` 优先报 disabled-mode 作用域错误，不落入范围错误。
- 调整 `scripts/acp_regression_suite.sh`：codex 阶段作为“可选探针”失败不再阻断主套件（保留 WARN），便于持续联调。
- 复跑 `RUN_CODEX_PROBES=1 ./scripts/acp_regression_suite.sh` 通过。
- 新增 `acp serve --help` 回归（2 条）：
  - 覆盖 `--prompt-timeout-ms / --session-ttl-ms / --permission-timeout-ms` 参数展示。
  - 覆盖 `permission-mode` 值域文案 `disabled | permissive | required`。
- 两条用例通过，且 `./scripts/acp_regression_suite.sh` 复跑通过。
- 补齐 `connect --transport ws` 参数回归（2 条）：
  - `--args` 在 ws 下必须报 `--args is only valid for stdio transport`。
  - `ws + --cmd + --args=--transport` 需命中提示分支，报 `--args=--flag` 用法提示。
- 两条用例通过，且 `./scripts/acp_regression_suite.sh` 复跑通过。
- runbook 同步：`RUN_CODEX_PROBES=1` 下 codex 探针阶段失败仅 WARN 不阻断主套件结果，和脚本行为保持一致。
- 新增 `serve --help` 回归：锁定 `--listen` 与 `--max-in-flight-sends` 文案展示。
- 该用例通过，且 `./scripts/acp_regression_suite.sh` 复跑通过。
- 新增 `connect-ws` 子命令 endpoint 格式回归（2 条）：
  - 拒绝 `http://` scheme。
  - 拒绝缺失 host 的 `ws:///path-only`。
- 两条用例通过，且 `./scripts/acp_regression_suite.sh` 复跑通过。
- 补齐 `ws + --cmd + --args` 错误分支完整文案断言：
  - 锁定提示文本 `--cmd is only valid for stdio transport (if child args start with '-', pass as --args=--flag)`。
- 用例通过，并复跑 `./scripts/acp_regression_suite.sh` 通过。
- 新增 `connect-ws` 端到端回归：`--request-timeout-ms=0` 在 ws 路径禁用超时并可正常 `end_turn`。
- 用例通过，并复跑 `./scripts/acp_regression_suite.sh` 通过。
- 新增 `serve --session-ttl-ms=0` 语义回归（ws）：
  - 实测行为为“会话立即过期”，客户端首个 prompt 返回 `Session not found`（exit=4）。
  - 已将该行为锁定为回归测试，避免后续语义漂移。

- 回归套件主流程新增第 4 段：`ws --session-ttl-ms=0` 立即过期边界探针（预期 `Session not found`, exit=4）。
- 新增脚本 `scripts/acp_ws_ttl_zero_probe.sh` 并接入 `scripts/acp_regression_suite.sh`；Runbook 同步更新为 4 段本地 ACP 主验收。

- 优化 `codex_acp_multiturn_smoke.sh` 超时策略：新增 `CODEX_ACP_TIMEOUT_MS`（默认 60000ms），降低 codex 冷启动抖动导致的首轮超时。
- `RUN_CODEX_PROBES=1 ./scripts/acp_regression_suite.sh` 本轮无重试直接通过（含 codex multi-turn）。

- 回归套件新增第 5 段本地 ACP：`ws --request-timeout-ms=0` 禁用超时边界（预期 `stopReason=end_turn`）。
- 新增脚本 `scripts/acp_ws_timeout_zero_probe.sh`，并接入 `scripts/acp_regression_suite.sh` 与 runbook。

- 回归套件新增 `ACP_PORT_BASE`（默认 18920），统一控制本地 ws 探针端口，支持并行跑多套联调避免端口冲突。
- 已验证 `ACP_PORT_BASE=19020` 与默认端口两种模式均 PASS。

- 回归套件支持 `CODEX_PROBE_RETRIES`（默认 2），可配置 codex 可选探针重试次数；非法值（如 0）会报错并 exit=2。
- 验证：`RUN_CODEX_PROBES=1 CODEX_PROBE_RETRIES=2 ./scripts/acp_regression_suite.sh` 通过；codex permission probe 出现一次抖动后按策略重试成功。

- 回归套件新增 `CODEX_PROBE_RETRY_DELAY_SECONDS`（默认 2）控制 codex 可选探针重试间隔，减少立即重试导致的连续抖动失败。
- 参数校验：`CODEX_PROBE_RETRY_DELAY_SECONDS=-1` 会报错并 exit=2；`RUN_CODEX_PROBES=1` 全套回归通过。

- 回归套件新增 `STRICT_CODEX_PROBES`（0/1）：`1` 时 codex 可选探针失败将直接 fail 套件，`0` 保持 warn-and-continue。
- 复验：`STRICT_CODEX_PROBES=1` 在 codex multi-turn 失败时正确退出失败；`STRICT_CODEX_PROBES=0` 同场景下输出 WARN 且套件 PASS。

- 回归套件新增 `ACP_SUITE_SUMMARY_JSON`：输出 JSON 汇总（整体 result + 每阶段 status/required/exitCode/message），失败路径也会写出。
- 已验证三种场景：仅本地阶段全 pass；非严格 codex 失败为 warn 且 result=pass；严格模式 codex 失败 result=fail。

- `ACP_SUITE_SUMMARY_JSON` 汇总新增时间与配置快照：`startedAtUtc/finishedAtUtc/durationSeconds/config`，便于 CI 对比波动与复现参数。
- 已验证本地 5 段回归通过，summary 字段完整可读。

- `ACP_SUITE_SUMMARY_JSON` 的 `stages[]` 新增 `durationSeconds` 与 `attempts`，支持直接定位慢阶段与重试抖动阶段。
- 已验证 codex 抖动场景：`codex_multiturn_smoke` 记录 `status=warn`、`attempts=2`、`exitCode=4`。

- summary 固定 7 段输出：当 `RUN_CODEX_PROBES=0` 时，两个 codex 阶段记录为 `status=skipped`（`attempts=0,durationSeconds=0`）。
- 已验证 `RUN_CODEX_PROBES=0/1` 两种模式 summary 结构一致。

- `ACP_SUITE_SUMMARY_JSON` 改为原子写入：先写临时文件再 `mv` 到目标路径，避免 CI 读取到半写入 JSON。
- 已复跑本地回归并确认 summary 正常生成。

- summary 顶层新增 `schemaVersion`（当前 `1`），并在写入后进行轻量自检（至少包含 `schemaVersion` 与 `stages`）。
- 已复跑本地回归，summary 输出与校验通过。

- summary 的 `stages[]` 新增固定 `index`（1..7），下游可按 index 稳定排序而不依赖 stage 名称。
- 已复跑回归并确认 index 与阶段顺序一致。

- summary 顶层新增 `runId`（每次执行唯一），用于关联同轮回归日志与产物。
- 已验证本地回归通过且 summary 包含 runId。

- 回归套件支持 `ACP_SUITE_RUN_ID` 覆盖 summary 的 `runId`（可直接注入 CI build/job id）。
- 修复原子写入临时文件模板兼容性：`mktemp` 改为 `.acp-summary.XXXXXX`，避免模板含后缀在并发/环境差异下失败。
- 已验证自动 runId 与自定义 runId 两种模式均通过（含自定义端口基线）。

- summary 的每个 `stage` 新增 `startedAtUtc/finishedAtUtc`，可与外部系统日志按时间线对齐。
- 已验证回归通过，7 个阶段均输出时间点字段。

- summary 顶层新增 `gitHead` 与 `gitDirty`，可将回归结果绑定到具体提交与工作区脏状态。
- 已复跑回归并确认字段输出正常。

- summary 顶层新增 `host` 元信息（`name/os/arch`），用于跨机器联调结果对比。
- 已复跑回归并确认字段输出正常。

- ACP 回归套件新增 `ACP_SUITE_LOG_DIR`，按 stage 产生日志文件（默认 `.local/acp-suite-logs/<runId>`）。
- summary schema 升级到 `2`：新增 `artifacts.suiteLogDir`，并为每个 stage 输出 `logPath` 便于失败定位。
- 已执行 `RUN_CODEX_PROBES=1` 全链路回归，7/7 通过并验证日志落盘。

- summary 写回后增加字段自检：必须包含 `schemaVersion/artifacts/stages/logPath`，降低格式漂移风险。

- required stage 日志补齐与 optional 一致的头信息（`attempt/timestamp/command`），便于统一检索与比对。

- summary schema 升级到 `3`，新增顶层 `stageCounts(total/pass/fail/warn/skipped)`，便于 CI 聚合判定。
- 已验证两种模式计数正确：`RUN_CODEX_PROBES=1` 为 `pass=7, skipped=0`；`RUN_CODEX_PROBES=0` 为 `pass=5, skipped=2`。

- 脚本完成时新增控制台计数行 `[suite] counts ...`，日志巡检无需额外 `jq` 即可判断分布。

- 计数行补齐模式信息：输出 `runCodexProbes` 与 `strictCodexProbes`，便于快速识别本轮执行配置。

- summary 新增 `failure` 字段：记录首个失败 stage 与 exit code（成功为 `null`），提升 CI 失败归因效率。

- summary 新增顶层 `exitCode`（脚本退出码），CI 可只解析 JSON 即完成结果判定与归因。

- summary 新增 `generatedBy`（`scripts/acp_regression_suite.sh@1`），用于区分多来源报告产物。

- summary 新增 `requiredPassed`，用于直接判断必选阶段是否全部通过（与可选探针状态解耦）。

- summary 新增 `requiredStageCounts/optionalStageCounts`，将必选与可选阶段统计拆分，便于 CI 与看板做分层分析。

- summary 新增 `countsConsistent`，用于检测统计总数与分项是否一致，降低后续演进中的报表偏差风险。

- summary 新增 `hasWarnings/hasSkipped` 布尔字段，便于 CI 基于布尔值快速分流策略。

- summary 新增 `allStagesPassed`，用于快速识别是否“所有阶段全 pass”。

- summary 新增 `ciRecommendation`，统一输出 `pass/pass_with_warnings/fail` 供 CI 直接分流。

- 终端计数行补齐 `requiredPassed` 与 `ciRecommendation`，无需解析 JSON 即可快速做人工判读。

- summary 校验升级为 `jq` 结构校验优先（无 jq 时保留文本兜底），减少字段存在但结构异常的漏检。

- summary 新增 `summaryHash`（SHA-256），用于快速比较回归结果是否一致（同配置+同阶段结果应同 hash）。

- summary 新增 `resultReason`，把 `ciRecommendation` 映射为人类可读原因，降低值班排障心智成本。

- summary 新增 `failedStages` 与 `nonPassStages`，可直接拿到异常阶段名列表用于告警文案/自动归因。

- summary 新增 `stageStatusMap`（`stage -> status`），调用方无需遍历 stages 即可直查阶段状态。

- summary 新增 `requiredFailedStages`，用于直接提取“必跑阻塞项”并驱动 CI 失败说明。

- summary 新增 `stageExitCodeMap`（`stage -> exitCode`），可用于自动归因规则直取退出码。

- summary 新增 `stageDurationSecondsMap`（`stage -> durationSeconds`），用于回归耗时趋势分析。

- summary 新增 `stageAttemptsMap`（`stage -> attempts`），用于定位可选探针抖动与重试成本。

- summary 新增 `stageMessageMap`（`stage -> message`），用于告警/报表直接引用阶段解释文案。

- summary 新增 `stageLogPathMap`（`stage -> logPath`），用于告警平台直接定位阶段日志文件。

- summary 新增 `stageRequiredMap`（`stage -> required`），调用方可直接判断阶段是否必跑。

- summary 新增 `stageStartedAtMap`（`stage -> startedAtUtc`），用于外部时序/排队分析。

- summary 新增 `stageFinishedAtMap`（`stage -> finishedAtUtc`），用于外部时序窗口计算。

- summary 新增 `stageIndexMap`（`stage -> index`），用于快速恢复阶段顺序。

- summary 新增 `probeMode`（`disabled | non_strict | strict`），调用方无需组合布尔开关即可判断探针策略。

- summary 新增 `warnStages`、`skippedStages`，调用方可直接获取 warning/skipped 阶段集合。

- summary 新增 `requiredStages`、`optionalStages`，便于调用方直接拿到阶段分组集合。
