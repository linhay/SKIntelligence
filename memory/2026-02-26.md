## 2026-02-26 外部参考仓整理
- 决策：建立统一长期参考入口目录 `External/references`，通过稳定命名的符号链接访问外部仓。
- Canonical 入口：`acp-spec`、`acp-kotlin-sdk`、`acp-kotlin-sdk-jetbrains`、`pi-mono`。
- 风险控制：暂不删除历史重复克隆目录，仅在 `External/references/README.md` 标注重复关系，避免破坏既有脚本路径。
- 调整：对 `External/` 进行去重整理。将重复克隆目录 `agentclientprotocol-spec`、`agentclientprotocol-kotlin-sdk` 迁移到 `External/_archive/`，并在原路径改为软链接指向 canonical 仓。
- 新增：`External/README.md` 作为外部参考仓结构与更新入口说明。
- 调整：按要求将 `External` 更名为 `references`，并移除目录内所有软链接；`references` 下仅保留真实项目目录。
- 里程碑：完成 Codex 通过 ACP 适配器（`@zed-industries/codex-acp`）的最小可用链路联调，`initialize + session/new + session/prompt` 成功返回 `prompt_result`。
- 关键修复：JSON-RPC 编码默认会把 `/` 转义为 `\\/`，导致 `codex-acp` Rust 侧出现 `expected a borrowed string` 并使 `session/new` 超时。已在 `JSONRPCCodec` 中启用 `.withoutEscapingSlashes`。
- 覆盖：新增 JSONRPC 编码测试，验证 method 字段不会被转义；并补充 Codex ACP 规格与运行手册文档。
- 联调增强：新增 `scripts/codex_acp_smoke.sh`，用于批量验证 `ski -> codex-acp` 最小链路；本地验证 `3/3` 成功。
- 边界结论：`--session-id` 在 `connect --transport stdio` 跨进程复用会失败（`Resource not found`），属于进程生命周期边界。
- 观测结论：`--permission-decision` 只在收到 ACP 权限请求时生效；对 codex-acp 某些路径可能无显著影响。
## ACP 联调增量（多轮与权限，2026-02-26 23:05）
- 新增 `acp client connect*` 多 `--prompt` 能力：单连接内顺序执行多轮 `session/prompt`，输出多条 `prompt_result`。
- 关键边界：`session-id` 不能跨“不同 client 连接”复用（ws 亦然），需在单连接内复用会话。
- 本地联调结论：
  - `serve --transport ws --permission-mode required` 下，`--permission-decision deny` 可稳定得到 `stopReason=cancelled`。
  - 本地 `serve --transport stdio` 多轮 prompt 当前存在第二轮超时限制，保留单轮验收。
- 新增脚本：`scripts/codex_acp_multiturn_smoke.sh`（codex-acp 多轮烟测）。
- 新增/更新测试：
  - `SKICLIProcessTests.testClientConnectViaWSServeProcessMultiplePromptsReuseSameSession`
  - `SKICLIProcessTests.testClientConnectViaWSRequiredPermissionDenyReturnsCancelled`
- `scripts/codex_acp_multiturn_smoke.sh` prompt 调整为短回复，已实测通过：`PASS ... prompt_result_count=2`。
- 新增 `scripts/acp_ws_permission_matrix.sh`：本地 ws(required) 权限矩阵一键联调，校验 allow=end_turn、deny=cancelled。
- 新增进程测试 `testClientConnectViaWSRequiredPermissionAllowReturnsEndTurn`，与 deny 用例组成权限分支回归闭环。
- 客户端新增权限请求计数日志：stderr 输出 `[SKI] ACP client permission requests=<N>`，用于联调时判定 `deny/allow` 是否进入 ACP 权限回调。
- `codex-acp` 实测（prompt: 执行 `date +%s`，`permission-decision=deny`）结果：`stopReason=end_turn` 且 `permission requests=0`，确认该路径未走 ACP `request_permission`。
- 新增 `scripts/codex_acp_permission_probe.sh`：一键对比 codex-acp 的 allow/deny，并输出 `permission_requests` 与 `stop_reason`。
- 新增测试 `testClientConnectViaWSDisabledPermissionReportsZeroRequests`，验证 permission disabled 下客户端计数为 0 且仍可 `end_turn`。
- 实测探针：allow/deny 均为 `permission_requests=0 stop_reason=end_turn`。
- 纠正结论：本地 `acp serve --transport ws` 在同一服务进程生命周期内支持跨连接 `--session-id` 复用（之前联调结论已过期）。
- 新增测试 `testClientConnectViaWSReusingSessionIDAcrossConnectionsSucceeds`。
- 新增脚本 `scripts/acp_ws_session_reuse_probe.sh`，可一键验证 ws session 复用。
- 新增 `stdio` 边界回归：`testClientConnectViaStdioReusingSessionIDAcrossConnectionsFails`。
- 新增脚本 `scripts/acp_stdio_session_reuse_probe.sh`，验证 stdio 跨连接复用 session-id 预期失败（exit=4）。
- 实测脚本通过：`PASS expected_failure_exit=4 ...`。
- 新增一键联调套件 `scripts/acp_regression_suite.sh`，串联 ws 权限矩阵、ws session 复用、stdio session 失败边界。
- 套件已实测通过：`[suite] PASS`。
- 支持可选附加 codex 探针：`RUN_CODEX_PROBES=1 ./scripts/acp_regression_suite.sh`。
- 新增参数边界回归 `testClientConnectRejectsMissingPrompt`：未传 `--prompt` 时返回 exit=2 和明确错误。
- 运行 `RUN_CODEX_PROBES=1 ./scripts/acp_regression_suite.sh` 全套通过：
  - ws 权限矩阵 PASS
  - ws session 复用 PASS
  - stdio session 失败边界 PASS
  - codex permission probe: allow/deny 均 `permission_requests=0 stop_reason=end_turn`
- 新增 `connect/connect-stdio/connect-ws` 缺省 `--prompt` 参数回归（3 条），统一要求 exit=2 + 明确错误信息。
- 复跑 `./scripts/acp_regression_suite.sh` 通过，关键 ACP 边界无回归。
- 新增 ws 无效 session-id 回归：`testClientConnectViaWSWithNonexistentSessionIDFails`（预期 exit=4）。
- runbook 补充：ws 存在 session-id 时可复用；不存在 session-id 时应 upstream failure。
- 新增 `--session-id` 空值参数回归（ws 子命令与通用 ws）：
  - `testClientConnectWSRejectsEmptySessionID`
  - `testClientConnectGenericWSRejectsEmptySessionID`
- 3 条 empty-session-id 回归均通过（exit=2 + 明确错误）。
- 新增缺关键参数回归：
  - `testClientConnectStdioRejectsMissingCmd`
  - `testClientConnectWSRejectsMissingEndpoint`
- 两条均验证 exit=2 与明确错误提示，已通过。
- 新增 `connect-stdio/connect-ws` 的负超时参数回归：
  - `testClientConnectStdioRejectsNegativeRequestTimeout`
  - `testClientConnectWSRejectsNegativeRequestTimeout`
- 复跑 `./scripts/acp_regression_suite.sh` 通过。
