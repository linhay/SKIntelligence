## ACP 传输稳定性里程碑（2026-02-12）
- 决策：将 `ACPTransportBackpressureGate` 改为 permit 模型，显式区分 `release` 唤醒（acquired=true）与取消唤醒（acquired=false）。
- 风险结论：修复了“等待发送任务被取消后 continuation 未恢复导致挂死/permit 泄漏”的并发缺陷。
- 验证：新增 `testBackpressureGateCancelledWaiterDoesNotLeakPermit`，先出现挂死红灯，再修复转绿；并回归 ACP 关键测试集合 41/41 通过。
- 后续行动：继续推进 websocket reconnect 默认回归化（非 live-only）与更高并发 fuzz 稳定性测试。
- 决策：为 `WebSocketClientTransport` 引入 `WebSocketConnectionFactory` 注入点，默认仍用 URLSession；测试侧新增无网络依赖的确定性重连回归（send/receive 两条路径）。
- 风险结论：将重连主回归从 live-only 转为默认可跑，降低 CI/本地网络抖动导致的假失败概率；live 重连测试继续保留为 opt-in 烟测。
- 决策：新增 `ACPClientService` 的并发随机 close 稳定性测试（200 并发），将可接受结果域明确为 success/eof/notConnected/requestTimeout。
- 风险结论：close 与并发请求竞态下，客户端状态可收敛（pending/timeout 清零），未观察到状态泄漏与挂死。
- 决策：新增 `SKICLIShared` 目标承载 CLI 参数校验与 transport 工厂逻辑，`SKICLI` 仅负责命令编排。
- 风险结论：规避了测试直接链接 executable target 的符号问题，CLI 校验逻辑可独立回归（`SKICLITests`）。
- 验证：新增 `SKICLITests`（stdio 缺参、ws 缺 endpoint、ws 有效构建、毫秒归一化）并通过；ACP+CLI 关键回归 48/48 通过。
- 决策：在 `SKICLIShared` 新增 `SKICLIExitCodeMapper` 与 `ACPCLIOutputFormatter`，并将 `SKICLI` 输出逻辑切换为 formatter。
- 风险结论：CLI 的参数错误退出码与 JSON 字段结构可独立回归，减少命令层内联逻辑导致的漂移。
- 验证：`SKICLITests` 新增 exit code mapper/json formatter 用例通过；ACP+CLI 关键回归提升到 52/52 通过。
- 决策：`ACPClientConnectCommand` 在参数校验失败路径显式抛 `ExitCode(2)`，并保留可读错误输出。
- 风险结论：修复了 CLI 参数错误实际退出码为 1 的偏差；实测 `ski acp client connect --transport ws --prompt hi` 现为 `EXIT:2`。
- 决策：CLI 运行期错误退出码策略补全：`ACPClientServiceError`/`ACPTransportError`/`URLError` 统一映射 `exit=4`（上游失败）。
- 验证：`SKICLITests` 新增 3 条 mapper 用例通过；实命令验证参数错误 `exit=2`、上游连接失败 `exit=4`。
- 决策：`ACPCLITransportFactory` 新增 `makeServerTransport`，并对 `--listen` 做 `host:port`（port 1...65535）前置校验。
- 风险结论：`acp serve --transport ws --listen invalid` 现在走参数错误路径，避免运行期才失败。
- 验证：新增 `SKICLITests` 的 server listen 校验用例通过；实命令验证 `SERVE_EXIT:2`。
- 决策：新增 `SKICLIProcessTests` 作为进程级黑盒回归，直接执行 `.build/.../ski` 校验 exit code 与 stderr。
- 风险结论：将“手工验证退出码”沉淀为自动化，降低 CLI 参数/上游错误码回归风险。
- 验证：`SKICLIProcessTests` 覆盖 client 参数错=2、client 上游失败=4、serve listen 非法=2，全部通过。
- 决策：`WebSocketServerTransport` 从单连接模型升级为多连接池，并支持多客户端并发接入。
- 决策：为消除跨客户端 JSON-RPC `id` 冲突，传输层对入站 request 采用内部唯一 `id` 重写（`s2c-<n>`），并在出站 response 时恢复原始 `id` 后定向回写。
- 风险结论：修复“response 被发到最后连接客户端”以及“不同客户端同号 id 冲突导致 requestTimeout”的协议级路由问题。
- 验证：新增 `ACPWebSocketMultiClientTests.testTwoClientsCanPromptConcurrentlyWithoutCrossRouting`（红灯->绿灯），并回归 ACP/CLI 关键测试 59/59 通过。
- 决策：新增多客户端 notification 广播回归测试 `testServerNotificationBroadcastsToAllConnectedClients`，覆盖场景 21。
- 决策：补齐 ACP 业务域的 `session/request_permission` 客户端处理链路（request->handler->response），并新增显式 handler 注册接口 `setPermissionRequestHandler`。
- 决策：`ACPAgentService` 增加协议门禁：仅支持 `initialize.protocolVersion == 1`；当 `capabilities.loadSession=false` 时，`session/load` 返回 method_not_found。
- 风险结论：避免了 permission 请求悬挂、协议版本静默降级、以及 capability 协商与方法可用性不一致。
- 验证：新增/更新 ACP 测试后，ACP+CLI 关键回归 65/65 通过。
- 决策：`ACPAgentService` 新增 `permissionRequester` 注入点，`session/prompt` 前可做权限决策；当 `allow=false` 时短路返回 `stopReason=cancelled`。
- 风险结论：确保权限拒绝路径不会误触发模型调用与 `session/update`；同时修复并发关闭竞态下 `CancellationError` 语义漂移，统一归一化为 EOF。
- 验证：新增 `testPermissionDeniedShortCircuitsPromptWithoutSessionUpdate`，并回归 ACP+CLI 关键测试 66/66 通过。
- 决策：新增 `ACPPermissionRequestBridge` 并接入 `acp serve` 主循环，实现 agent 发起 `session/request_permission` 的请求-响应匹配、超时与连接关闭清理。
- 决策：`acp client connect` 默认注册自动允许的 permission handler，保证 CLI 基线链路可直接跑通。
- 验证：新增 `ACPPermissionRequestBridgeTests` 与 `ACPWebSocketPermissionRoundtripTests`，ACP+CLI 关键回归提升到 71/71 通过。
- 决策：新增 CLI permission 策略配置：serve 侧 `--permission-mode disabled|permissive|required`，client 侧 `--permission-decision allow|deny`。
- 风险结论：`permissive` 可兼容未实现 permission 的旧 client；`required` 提供严格策略，避免静默放行。
- 验证：新增 `SKICLITests` 策略语义用例，ACP+CLI 关键回归提升到 73/73 通过。
- 决策：ACP 方法域新增 `authenticate`、`session/set_mode`、`session/set_config_option`，并在 `ACPMethods` 中补齐 `fs/*` 与 `terminal/*` 常量。
- 决策：`ACPAgentService` 增加 `authMethods` 与 `authenticationHandler` 注入点；`initialize` 回传 `authMethods`；`set_mode`/`set_config_option` 同步产生 `session/update`（`current_mode_update`/`config_option_update`）。
- 决策：`ACPClientService` 增加 incoming request typed handler 分发器，支持 `fs/read_text_file`、`fs/write_text_file`、`terminal/create|output|wait_for_exit|kill|release` 回调注册。
- 风险结论：新增协议字段可能破坏历史 payload 解码，因此为 `ACPAgentCapabilities`、`ACPInitializeResult`、`ACPSessionUpdatePayload` 增加 decode fallback，缺字段按默认值回退。
- 验证：新增/更新测试后，ACP+CLI 关键回归 77/77 通过。

## ACP Stable 收敛（strict new model）补充（2026-02-12）
- 决策：`session/request_permission` 全链路切换到 stable `outcome` 结构（`selected{optionId}` / `cancelled`），移除 `allow/message` 旧语义。
- 决策：`ACPAgentService` 在 `session/new`/`session/load` 返回中补齐 `modes` 与 `configOptions` 结构；`session/set_config_option` 输出标准 `select` config option 载荷。
- 决策：`terminal/output` 响应收敛为 `output + truncated + exitStatus`，`terminal/wait_for_exit` 响应收敛为 `exitCode/signal`。
- 决策：`acp client connect` 接入真实 client-side `fs/*` 与 `terminal/*` handlers，并在 initialize 声明 `fs/terminal` capabilities。
- 决策：`WebSocketServerTransport` 增加 `sessionId -> owning connection` 路由，server-initiated request 与含 `sessionId` 通知按会话归属投递。
- 风险结论：此次为协议面破坏式收敛，需确保上下游同时升级；已通过本地 ACP+CLI 关键回归验证。
- 验证：执行回归命令 `swift test --filter 'SKIntelligenceTests.(ACPPermissionRequestBridgeTests|ACPWebSocketPermissionRoundtripTests|ACPWebSocketMultiClientTests|ACPWebSocketRoundtripTests|ACPClientServiceTests|ACPAgentServiceTests|ACPTransportResilienceTests|ACPWebSocketClientDeterministicReconnectTests|JSONRPCCodecTests|SKICLITests|SKICLIProcessTests)'`，结果 77/77 通过。

## ACP SessionUpdate 强类型化（2026-02-12）
- 决策：将 `ACPSessionUpdatePayload.sessionUpdate` 从 `String` 改为 `ACPSessionUpdateKind` 枚举，严格限定 stable discriminator。
- 决策：为 `session/update` 增加 `plan`、`availableCommands` 载荷模型，补齐 `ACPPlanEntry`、`ACPPlan`、`ACPAvailableCommand`。
- 风险结论：降低了 agent/client 自由字符串导致的协议漂移风险，但旧字符串写法需同步替换到 `.rawValue` 或枚举值。
- 验证：新增 `ACPModelsTests`（3 条）并通过；执行回归 `swift test --filter 'SKIntelligenceTests.(ACPModelsTests|ACPAgentServiceTests|ACPClientServiceTests|ACPPermissionRequestBridgeTests|ACPWebSocketPermissionRoundtripTests|JSONRPCCodecTests|SKICLITests)'`，69/69 通过。

## ACP Tool Call 生命周期（2026-02-12）
- 决策：`ACPAgentService.session/prompt` 在成功路径发送 `tool_call -> tool_call_update -> agent_message_chunk` 三段式通知。
- 约束：取消/超时路径不发 tool call 生命周期通知，保持既有“取消/超时无 message update”语义，避免污染状态机。
- 验证：新增 `ACPAgentServiceTests.testPromptEmitsToolCallLifecycleBeforeMessageChunk` 与 websocket 顺序断言；回归命令 `swift test --filter 'SKIntelligenceTests.(ACPPermissionRequestBridgeTests|ACPWebSocketPermissionRoundtripTests|ACPWebSocketMultiClientTests|ACPWebSocketRoundtripTests|ACPClientServiceTests|ACPAgentServiceTests|ACPTransportResilienceTests|ACPWebSocketClientDeterministicReconnectTests|JSONRPCCodecTests|SKICLITests|SKICLIProcessTests|ACPModelsTests)'`，81/81 通过。

## ACP Plan/Commands 生命周期（2026-02-12）
- 决策：在 `session/prompt` 成功路径加入 `available_commands_update` 与 `plan` 的业务发射，且位于 tool call 生命周期之前。
- 顺序：`available_commands_update -> plan -> tool_call -> tool_call_update -> agent_message_chunk`。
- 风险结论：若在取消/超时路径发射会破坏现有“无更新”断言；已确保仅成功路径发射。
- 验证：更新 `ACPAgentServiceTests` 与 `ACPWebSocketRoundtripTests` 顺序断言；ACP+CLI 关键回归 81/81 通过。

## ACP ToolCall 字段补齐（2026-02-12）
- 决策：`ACPToolCallUpdate` 收敛到 ACP stable 工具调用字段集合，新增 `kind/status/content/locations/rawInput/rawOutput`，并引入 `ACPToolCallContent(content|diff|terminal)`、`ACPToolCallLocation`。
- 决策：`ACPAgentService` 的 `tool_call` 改为发 `kind=execute,status=in_progress,locations=[cwd]`，`tool_call_update` 发增量 `status=completed`。
- 风险结论：`tool_call_update` 的 `title` 改为可选后，上游代码需按可选值处理；现有 permission/roundtrip 回归已覆盖关键路径。
- 验证：执行 `swift test --filter 'SKIntelligenceTests.(ACPModelsTests|ACPAgentServiceTests|ACPWebSocketRoundtripTests|ACPWebSocketPermissionRoundtripTests|ACPClientServiceTests|ACPPermissionRequestBridgeTests)'`，46/46 通过。

## ACP ContentBlock 扩展（2026-02-12）
- 决策：新增 `ACPContentBlock` 并统一 `ACPPromptContent` / `ACPSessionUpdateContent` 到同一模型，支持 `image/audio/resource_link` 基础字段。
- 决策：保留向后兼容的 `text` 构造与 `type+text` 编解码路径；现有 prompt 文本拼接逻辑仅消费 text。
- 风险结论：非 text 内容当前不参与 `session.respond(to:)` 文本拼接，属于有意保守策略；后续可升级为多模态输入处理。
- 验证：新增 `testPromptContentImageRoundTrip`、`testSessionUpdateContentResourceLinkRoundTrip`；并回归 ACP+CLI 关键测试 85/85 通过。

## ACP ContentBlock 强类型收敛（2026-02-12）
- 决策：将 `ACPContentBlock` 从“宽字段 struct”升级为判别联合（`text/image/audio/resource_link/resource/unknown`），并提供兼容属性访问（`type/text/...`）避免调用面大改。
- 决策：保留兼容初始化器 `init(type:text:data:...)`，使历史构造写法仍可工作；未知 type 进入 `unknown` 并保存原始 payload。
- 风险结论：协议解码更严格后，错误类型将更早暴露；`unknown` 分支已覆盖前向兼容，风险可控。
- 验证：新增 `testSessionUpdateContentUnknownTypePreserved`；`ACPModelsTests` 8/8 通过，ACP 核心回归组继续全绿。
- ACP 业务域收敛：`ACPSessionUpdatePayload` 从“可选字段大包”升级为判别联合驱动（内部 `update: ACPSessionUpdate`），按 `sessionUpdate` kind 严格解码必需字段，减少协议漂移。
- 新增 ACP golden fixture 回归：`Tests/SKIntelligenceTests/Fixtures/acp-session-update/*.json` + `ACPGoldenFixturesTests`，覆盖 `tool_call_update` 与 `agent_message_chunk` 的 decode->encode 双向一致性。
- 新增跨传输一致性测试：`ACPTransportConsistencyTests` 比较 ws/stdio `session/update` 序列；当前环境 stdio 子进程 initialize 超时时按 `XCTSkip` 处理，已在 ops 文档记录风险与后续排查动作。
- 修复 stdio 请求回写死锁：`ACPServeCommand` 在 `transport=stdio` 下不再 `Task` 异步回写 response，而是同步处理 request 后立即 send；根因是 `StdioTransport.receive()` 阻塞 actor，异步 send 容易饥饿。
- 手工管道验证：向 `ski acp serve --transport stdio` 发送 `initialize` JSON-RPC 请求已返回规范响应。
- 回归：`swift test --filter ACP --filter SKICLI` 通过（80 passed, 2 skipped, 0 failed）；`ACPTransportConsistencyTests` 保持 stdio 超时保护性 skip，后续继续排查 ProcessStdioTransport 场景不稳定。
- ACP 一致性回归稳定化：`ACPTransportConsistencyTests` 的 stdio 分支改为原生 JSON-RPC 顺序收发（initialize/new/prompt + session_update 收集），避免依赖 `ACPClientService + ProcessStdioTransport` 组合的环境抖动。
- `ProcessStdioTransport` 从 actor 改为 class + 锁，消除 send/receive 互斥饥饿风险（后续可继续按 Swift 6 并发规范收敛锁调用告警）。
- 当前回归结果：`swift test --filter ACP --filter SKICLI` => 80 passed, 1 skipped, 0 failed；`ACPTransportConsistencyTests` 已通过。
- 进一步稳定 stdio 传输：`ACPTransportConsistencyTests` 改为 stdio 原生 JSON-RPC 顺序收发后，已从 skip 变为 pass。
- `ProcessStdioTransport` 改为 class + dispatch queue 同步保护状态与读取，规避 actor 阻塞读导致的 send/receive 饥饿；同时避免 NSLock 在 async context 的并发告警。
- 最新回归：`swift test --filter ACP --filter SKICLI` 通过（80 passed, 1 skipped, 0 failed）。
## 18:36 ACP unstable session 域补齐
- 完成方法域：`session/list`、`session/resume`、`session/fork`、`session/set_model`。
- 完成模型域：`ACPSessionModelState/ACPModelInfo` 以及 list/resume/fork/set_model 的 params/result。
- `ACPAgentService` 完成 capability 门禁与成功路径：
  - list/resume/fork 在 capability 关闭时返回 `method_not_found`；
  - 开启后可正常返回会话列表、恢复会话、分叉会话；
  - set_model 会校验 modelId 并更新会话模型状态。
- `ACPClientService` 新增 API：`setModel/listSessions/resumeSession/forkSession`。
- `acp serve` 默认声明 `sessionCapabilities.list/resume/fork`。
- 测试：新增 `ACPModelsTests`、`ACPAgentServiceTests`、`ACPClientServiceTests` 对应用例，均通过。
- 风险结论：ACP 全量回归中 `ACPWebSocketPermissionRoundtripTests` 偶发端口占用（Address already in use），单测重跑通过，判定为环境端口竞争。
## 19:05 ACP 检查单三项收敛（分页 / golden / stdio）
- 决策：`session/list` 从占位语义切换为真实 cursor 分页，`ACPAgentService.Options` 新增 `sessionListPageSize`（默认 50，最小 1）。
- 决策：cursor 采用 opaque base64 token（`v1:<offset>` 编码），无效或越界 cursor 统一返回 `invalid params (-32602)`。
- 决策：`session/list` 结果排序固定为 `lastTouched` 降序 + `sessionId` 升序，保证分页稳定；`updatedAt` 改为会话状态变更时更新。
- 决策：golden fixture 扩展到 `available_commands_update` 与 `current_mode_update`，纳入 `ACPGoldenFixturesTests` 回归。
- 里程碑：检查单“后续动作”三项全部完成并在 `docs-dev/ops/ACP-Business-Domain-Checklist-2026-02-12.md` 勾选。
- 验证：
  - `swift test --filter ACPAgentServiceTests/testSessionListSupportsCursorPagination --filter ACPAgentServiceTests/testSessionListInvalidCursorReturnsInvalidParams --filter ACPGoldenFixturesTests` 通过；
  - `swift test --filter ACPTransportConsistencyTests` 通过（stdio + ws 一致性）；
  - `swift test --filter ACPModelsTests --filter ACPAgentServiceTests --filter ACPClientServiceTests --filter ACPGoldenFixturesTests --filter ACPTransportConsistencyTests` 通过（56/56）。
## 19:14 ACP 新增域：session/delete + session_info_update
- 决策：新增 `session/delete` 方法与 `sessionCapabilities.delete` 能力位；能力未声明时返回 `method not found (-32601)`。
- 决策：`session/delete` 采用幂等语义：会话不存在或重复删除也返回成功，且删除后不再出现在 `session/list`。
- 决策：新增 `session_info_update` 通知模型：`ACPSessionInfoUpdate(title, updatedAt)`，接入 `ACPSessionUpdateKind` 判别联合。
- 决策：`ACPAgentService.Options` 新增 `autoSessionInfoUpdateOnFirstPrompt`（默认 `false`），用于首次 prompt 成功后可选发射 `session_info_update`，避免默认路径影响既有 update 生命周期顺序。
- 决策：`ACPClientService` 新增 `deleteSession(_:)` API；`acp serve` 默认能力声明增加 `delete`。
- 决策：golden fixture 新增 `session_info_update.json`，纳入 roundtrip 回归。
- 验证：
  - `ACPAgentServiceTests` 新增 3 条（delete capability/delete idempotent/session_info_update）通过；
  - `ACPModelsTests` 新增 2 条（delete params/session_info_update roundtrip）通过；
  - `ACPClientServiceTests` 会话域链路继续通过（含 delete）；
  - `ACPGoldenFixturesTests` 通过；
  - 组合回归 `swift test --filter ACPModelsTests --filter ACPAgentServiceTests --filter ACPClientServiceTests --filter ACPGoldenFixturesTests --filter ACPTransportConsistencyTests` 61/61 通过。

## ACP 业务域增量（协议级取消）
- 决策：对齐 ACP unstable schema，补齐协议级通知 `$/cancel_request`，用于按 requestId 取消运行中的请求。
- 实现：
  - `ACPMethods.cancelRequest = "$/cancel_request"`
  - `ACPCancelRequestParams(requestId: JSONRPCID)`
  - `ACPAgentService` 新增运行映射 `request.id -> sessionId`，收到 `$/cancel_request` 时定位并取消对应 prompt。
  - `JSONRPCErrorCode` 增加 `requestCancelled = -32800` 常量（后续可用于标准错误响应）。
- 测试：
  - `ACPAgentServiceTests.testPromptCanBeCancelledByProtocolCancelRequest`
  - `ACPModelsTests.testCancelRequestParamsRoundTrip`
  - ACP 主回归组合（Models/Agent/Client/Golden/TransportConsistency）通过。
- 风险结论：当前 `$/cancel_request` 先落地为“取消执行语义”（prompt 返回 `stopReason=cancelled`），尚未统一返回 `-32800` 错误对象；对现有调用兼容且无行为回退。

## ACP 快速收口（logout + 取消语义）
- 决策：为协议对齐补齐 `logout` 与 `authCapabilities.logout`，并将 `$/cancel_request` 命中请求时返回语义收敛到 `-32800`。
- 实现：
  - `ACPMethods.logout`
  - `ACPAgentCapabilities.authCapabilities.logout`
  - `ACPLogoutParams/ACPLogoutResult`
  - `ACPClientService.logout(_:)` 与 `ACPClientService.cancelRequest(_:)`
  - `ACPAgentService.logout` 门禁与上下文清理
  - `ACPAgentService` 协议级取消命中时返回 `JSONRPCErrorCode.requestCancelled (-32800)`
- 测试：logout/cancel_request 新增与回归均通过（ACP 核心组合 67 tests 全绿）。
- 风险结论：`logout` 目前以“清理会话上下文”为主，后续若接入真实凭据存储可再扩展 token/session 清理细节。

## ACP 协议一致性守卫（22:30）
- 决策：新增 `ACPMethodCatalog`，将方法域拆分为 `stableBaseline`、`unstableBaseline`、`projectExtensions`，避免协议方法随迭代漂移。
- 决策：引入官方 `meta.json/meta.unstable.json` 快照 fixture，新增 `ACPProtocolConformanceTests` 对齐校验。
- 决策：项目扩展方法固定为 `logout` 与 `session/delete`，通过测试显式锁定，不允许隐式扩散。
- 验证：`swift test --filter ACPProtocolConformanceTests` 与 `swift test --filter ACP --parallel` 全通过（90/90）。
- 风险结论：fixture 为快照机制，未来 ACP 官方 schema 升级时需同步更新 fixture 与 catalog，否则测试会主动失败提示对齐。

## Permission Policy 业务域实现（23:40）
- 决策：按 pi-mono 的可插拔门控思路实现 Permission Policy，不在 agent 主流程中硬编码固定授权逻辑。
- 决策：默认策略模式采用 ask，记忆范围限定为 session 级；仅 `allow_always/reject_always` 进入记忆。
- 决策：`SKICLIServePermissionMode` 映射为策略模式：`disabled -> allow`，`permissive|required -> ask`，并保留 bridge 错误语义差异。
- 实现：新增 `SKIACPAgent/PermissionPolicy` 模块（mode/protocol/memory/fingerprint/bridge policy），并接入 `ACPAgentService(permissionPolicy:)`。
- 实现：`session/prompt` 权限选项补齐 `allow_always/reject_always`；`session/delete` 和 `logout` 时清理会话权限记忆。
- 测试：新增 `ACPPermissionPolicyTests` 7 条；ACP 全量回归 `swift test --filter ACP --parallel` 97/97 通过。
- 风险结论：当前指纹基于 `kind/title/locations/rawInput`，若上游 tool payload 大幅变化会影响记忆命中率，但不会降低安全性（最坏退化为重新询问）。
