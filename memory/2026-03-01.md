# 2026-03-01

## Wax 兼容性调查与参考落地

- 已将上游仓库拉取到 `references/Wax`，用于后续源码级对照和离线审阅。
- 新增文档：`docs-dev/dev/Wax-Single-File-Memory-Architecture.md`。

## 关键结论

- Wax 的持久层是单 `.wax` 文件，布局包含 Header A/B、WAL、payload、TOC、footer。
- 持久与恢复机制依赖 WAL ring + 双页头选择 + footer 扫描 + checksum + open 阶段修复。
- 搜索能力由 FTS5(BM25) + 向量检索(USearch/Metal) + RRF 混合融合组成。
- “私有”是默认本地化和无云依赖，不等同于默认应用层加密落盘。

## 风险结论

- 若面向合规/高敏业务，仍需补“加密静态数据”方案，不能仅以本地存储作为充分条件。

## 文档增补（MiniLM 调用链）

- 已在 `docs-dev/dev/Wax-Single-File-Memory-Architecture.md` 增补 `MiniLM-L6-v2.mlmodelc` 调用链路：
  - 资源打包（Package target resources）
  - 初始化入口（`MemoryOrchestrator.openMiniLM`）
  - 模型加载（`Bundle.module` + `MLModel(contentsOf:)`）
  - 推理路径（Tokenizer -> prediction -> 384 维向量）
  - 与向量/混合检索链路的接点（`MemoryOrchestrator`）

## SKIntelligence Token Usage Tracking（仅 Token）

- 决策：费用追踪第一版只做 token 统计，不做金额换算与预算控制。
- 决策：对外接口采用会话聚合查询，新增 `SKILanguageModelSession.tokenUsageSnapshot()/resetTokenUsage()`。
- 决策：统计仅保存在会话内存态，不写入 transcript/memory 持久层。
- 决策：同步 `respond` 与流式 `streamResponse` 两条链路同时覆盖。

### 实施与验证

- 新增 `SKITokenUsageSnapshot` 公共类型。
- `SKILanguageModelSession` 增加 usage 聚合器，并在非流式与流式路径中累计 `ChatUsage`。
- 流式路径默认设置 `stream_options.include_usage = true`。
- `SKIAgentSession.SessionStats` 新增 `tokenUsage` 字段并透传会话累计。
- 新增测试：`SKITokenUsageTrackingTests`（5 个场景）。
- 回归通过：
  - `swift test --filter SKITokenUsageTrackingTests`
  - `swift test --filter SKIStreamingTests`
  - `swift test --filter SKIAgentSessionTests`

### 风险结论

- 兼容风险低：仅新增字段/方法，不破坏既有 API 语义。
- provider 不返回 usage 时，统计保持 0，不影响主流程。

## OpenAIClient 端点回退重构（Profile 化）

- 决策：端点配置改为 `profiles: [EndpointProfile]`，不再区分主/备，按数组顺序回退。
- `EndpointProfile` 聚合字段：`url/token/model/headerFields`，切换时整组切换。
- 兼容策略：保留旧 `.url/.token/.model/fallbackURLs` 入口，但标记 `deprecated` 并映射到 `profiles`。
- 认证优先级：`headerFields.Authorization` 优先；仅在缺失时使用 `token` 自动补 `Bearer`。
- 空配置策略：`profiles` 为空时，`respond/streamingRespond` 立即返回 `invalidArguments`。
- 流式回退边界：仅在尚未收到任何 chunk 的连接失败阶段才切到下一个 profile。

### 新增测试

- `OpenAIClientFallbackEndpointTests`
  - profile 顺序回退成功
  - 无回退配置时失败语义保持
  - Authorization 优先级
  - 空 profiles 抛错

### 回归

- `swift test --filter OpenAIClientFallbackEndpointTests`
- `swift test --filter OpenAIClientDecodingDiagnosticsTests`
- `swift test --filter SKIStreamingTests`

## OpenAIClient 调用迁移到 profiles

- 已批量把仓库内 `OpenAIClient` 调用从 `.url/.token/.model` 链式写法迁移到 `.profiles([EndpointProfile(...)])`。
- 迁移文件：
  - `Tests/SKIntelligenceTests/SKIMCPIntegrationTests.swift`
  - `Tests/SKIntelligenceTests/TavilySearchTest.swift`
  - `Tests/SKIntelligenceTests/MedicalReportTests.swift`
  - `Tests/SKIntelligenceTests/GameTests.swift`
  - `docs-dev/dev/Streaming.md`
  - `docs-dev/ops/Release-1.3.17.md`
- 结果：相关测试编译与执行通过，避免继续触发已弃用 API 的调用告警。
