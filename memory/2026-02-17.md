# 2026-02-17

## SKIAgentSession 分叉能力对齐（pi 核心）
- 决策：在不引入预算控制与复杂会话树管理的前提下，先补齐“按用户消息选择分叉”的最小可用能力。
- 实现：
  - `SKITranscript` 新增 `forkableUserMessages()` 与 `entriesForFork(fromUserEntryIndex:)`。
  - `SKIAgentSession` 新增 `forkableUserMessages()` 与 `fork(fromUserEntryIndex:)`。
  - 复用既有 fork 构建链路，确保工具注册与 MCP 工具在分叉会话中继续可用。
- 验证：
  - 新增测试 `testForkableUserMessagesReturnsPromptHistoryInOrder`
  - 新增测试 `testForkFromSelectedUserEntryKeepsEarlierContextOnly`
  - `swift test --filter SKIAgentSessionTests` 全通过。
- 风险结论：
  - 当前使用 `entryIndex` 作为分叉锚点，适合单次会话内操作；若后续要跨持久化稳定引用，需补充持久化 entry id。

## SKIAgentSession 排队语义（steer/followUp）
- 决策：在不引入完整 TUI/事件总线的前提下，先补齐最小排队语义。
  - 新增 `StreamingBehavior(reject/steer/followUp)`。
  - 新增 `steer(_:)` / `followUp(_:)` / `pendingMessageCount()`。
  - `prompt(..., streamingBehavior:)` 在运行中可选择入队而非直接报错。
- 实现：`SKIAgentSession` 内部引入 `pendingPrompts`，首请求完成后顺序 drain 队列。
- 验证：
  - `testPromptWithFollowUpBehaviorQueuesAndExecutesInOrder`
  - `testSteerQueuesFireAndForgetDuringActivePrompt`
  - `swift test --filter SKIAgentSessionTests` 全通过（9/9）。

## SKITool 元信息与会话工具清单
- 决策：对齐 pi 的工具可观测能力，先落地“会话内可查询工具清单/启用状态”，不引入动态工具权限域。
- 实现：
  - 新增 `SKIToolMetadata(name/description/shortDescription/isEnabled/parameters)`。
  - `SKITool` 扩展新增 `metadata` 默认实现。
  - `SKIAgentSession` 新增：
    - `toolDescriptors()`
    - `activeToolNames()`
    - `unregister(toolNamed:)`
    - `unregister(mcpToolNamed:)`
- 验证：
  - `testToolDescriptorsExposeMetadataAndEnabledState`
  - `testActiveToolNamesAndUnregisterReflectCurrentState`
  - `swift test --filter SKIAgentSessionTests` 全通过（11/11）。

## SKITranscript 事件层结构化上下文
- 决策：事件总线保持轻量，不做复杂 union；先增加 `source/entryIndex` 以减少 UI 二次关联成本。
- 实现：
  - `SKITranscript.Event` 新增 `source: EventSource?`、`entryIndex: Int?`。
  - 新增 `EventSource(transcript/session)`。
  - `events()` 聚合时为 transcript 事件自动填充 `entryIndex`。
  - `sessionUpdateEvent()` 标记 `source = .session`。
- 验证：
  - `SKITranscriptEventContractTests` 新增 `testEventsFromEntryWithIndexAnnotatesAllProducedEvents`。
  - `testTranscriptAggregatesEventSequence` 增加 `entryIndex/source` 断言。
  - 回归：`swift test --filter SKITranscriptEventContractTests --filter SKIAgentSessionTests` 通过（17/17）。

## SKIAgentSession 会话统计
- 决策：补齐 pi 常用的 session stats 查询入口，先提供“结构计数”而非 token/cost（保持当前无预算模型）。
- 实现：
  - `SKIAgentSession.SessionStats`：
    - `sessionId`
    - `userMessages/assistantMessages/toolCalls/toolResults`
    - `totalEntries/pendingMessages`
  - 新增 `stats()`，基于 transcript entries 实时聚合。
- 验证：
  - 新增 `testSessionStatsCountsMessagesAndToolLifecycle`
  - 回归：`swift test --filter SKIAgentSessionTests` 通过（12/12）。

## SKIAgentSession 待处理队列快照
- 决策：为 UI 与调试侧补齐 pending 队列可观测能力，不改变执行语义。
- 实现：
  - 新增 `PendingMessageSource`（`prompt_follow_up/steer/follow_up`）。
  - 新增 `PendingMessageDescriptor(source,textPreview)`。
  - 新增 `pendingMessages()`，按队列顺序返回快照。
  - 入队时记录来源：
    - `prompt(..., streamingBehavior: .followUp)` -> `prompt_follow_up`
    - `steer()` -> `steer`
    - `followUp()` -> `follow_up`
- 验证：
  - 新增 `testPendingMessagesSnapshotIncludesSourceAndPreview`
  - 回归：`swift test --filter SKIAgentSessionTests --filter SKITranscriptEventContractTests` 通过（19/19）。

## SKIAgentSession pending 分组统计
- 决策：`stats()` 增加 pending 来源分组，便于 UI 直接显示“排队来源构成”。
- 实现：
  - `SessionStats` 新增 `pendingBreakdown(promptFollowUp/steer/followUp)`。
  - `stats()` 聚合 pending 队列时按来源统计分组数量。
- 验证：
  - 新增 `testSessionStatsPendingBreakdownCountsBySource`
  - 回归：`swift test --filter SKIAgentSessionTests --filter SKITranscriptEventContractTests` 通过（20/20）。

## SKIAgentSession 最近更新时间
- 决策：补齐 `stats().lastUpdatedAt`，用于会话列表排序与“最近活跃”显示。
- 实现：
  - `SKITranscript` 新增 `lastUpdatedAt`。
  - `append(entry:)` 写入时刷新 `lastUpdatedAt = Date()`。
  - `replaceEntries(_:)` 在非空替换时刷新 `lastUpdatedAt`，空替换置 nil。
  - `SessionStats` 新增 `lastUpdatedAt`，由 `SKIAgentSession.stats()` 透传。
- 验证：
  - 新增 `testSessionStatsLastUpdatedAtIsNilWhenEmptyAndAdvancesAfterUpdates`
  - 回归：`swift test --filter SKIAgentSessionTests --filter SKITranscriptEventContractTests` 通过（21/21）。

## Pending 预览截断策略
- 决策：pending 文本预览统一长度，避免 UI 侧各自实现截断规则。
- 实现：
  - `pendingMessages()` 预览统一走 `promptPreview`：
    - 归一化换行（`\r\n` -> `\n`）
    - 超过 120 字符时截断并追加 `...`
- 验证：
  - 新增 `testPendingMessagesPreviewUsesStableMaxLength`（150 字符输入 -> 123 字符输出，后缀 `...`）
  - 回归：`swift test --filter SKIAgentSessionTests --filter SKITranscriptEventContractTests` 通过（22/22）。

## Pending 预览长度可配置
- 决策：在统一默认策略基础上，允许调用方按界面场景自定义预览长度。
- 实现：
  - `pendingMessages(maxLength:)`，默认 `120`（`SKIAgentSession.defaultPendingPreviewMaxLength`）。
  - `maxLength` 下限钳制为 `1`，避免异常输入导致空 slice 逻辑分散。
- 验证：
  - 新增 `testPendingMessagesSupportsCustomPreviewMaxLength`（`maxLength=10` -> `"yyyyyyyyyy..."`）。
  - 回归：`swift test --filter SKIAgentSessionTests --filter SKITranscriptEventContractTests` 通过（23/23）。

## Pending 已处理历史（调试视图）
- 决策：`pendingMessages` 增加可选 resolved 视图，用于问题回放，不影响默认行为。
- 实现：
  - `PendingMessageDescriptor` 新增 `status(queued/resolved/failed)`。
  - `pendingMessages(maxLength:includeResolved:)`：
    - 默认仅返回 queued。
    - `includeResolved=true` 时追加最近已处理项。
  - 新增内存缓冲 `resolvedPendingHistory`，上限 20（`resolvedPendingHistoryLimit`）。
- 验证：
  - 新增 `testPendingMessagesCanIncludeResolvedHistory`
  - 回归：`swift test --filter SKIAgentSessionTests --filter SKITranscriptEventContractTests` 通过（24/24）。

## Pending 状态清理接口
- 决策：补齐调试与复位场景需要的显式清理 API。
- 实现：
  - `clearPendingHistory()`：仅清理 resolved 历史。
  - `clearPendingState(cancelActivePrompt: Bool = false)`：
    - 清理 queued + resolved；
    - awaiting continuation 统一回 `CancellationError`；
    - 可选取消当前运行中的 prompt。
- 验证：
  - 新增 `testClearPendingHistoryOnlyRemovesResolvedItems`
  - 新增 `testClearPendingStateCancelsQueuedFollowUpContinuations`
  - 新增 `testClearPendingStateCanCancelActivePromptWhenRequested`
  - 回归：`swift test --filter SKIAgentSessionTests --filter SKITranscriptEventContractTests` 通过（27/27）。

## SKIAgentSession 空闲 followUp 重复执行缺陷修复
- 现象：`followUp()` 在会话空闲时会重复执行同一条消息（先作为 loop 起始 prompt，再被 pending 队列再次消费）。
- TDD：先新增 `testFollowUpWhenIdleExecutesOnce`，红灯复现（实际出现两条同文案 prompt）。
- 修复：`enqueueFireAndForget` 仅在 `activePromptTask != nil` 时入队；空闲时直接启动 prompt loop，不再把首条 fire-and-forget 重复塞进 pending。
- 验证：新增用例转绿，并通过 `swift test --filter SKIAgentSessionTests --filter SKITranscriptEventContractTests`（30/30）。

## MCP 卸载链路补齐（AgentSession -> ModelSession）
- 决策：`unregister(mcpToolNamed:)` 必须同步到底层 `SKILanguageModelSession`，避免仅 UI 列表移除而实际仍可调用。
- 实现：
  - `SKILanguageModelSession` 新增 `unregister(mcpToolNamed:)`。
  - `SKIAgentSession.unregister(mcpToolNamed:)` 增加对底层 session 的转发。
- TDD：新增 `testMCPToolDescriptorsAndUnregisterReflectCurrentState` 覆盖注册/可见/卸载全链路。
- 验证：相关测试通过，未引入回归。

## SKIAgentSession activePromptTask 生命周期收口
- 决策：将 `activePromptTask` 清理时机内聚到 `runPromptLoop` 的 `defer`，不再依赖外部异步回调清理。
- 实现：
  - 移除 `prompt(...)` 里的 `defer { activePromptTask = nil }`。
  - 移除 `enqueueFireAndForget` 的后台 `finishBackgroundPromptLoop()` 回调清理。
  - 在 `runPromptLoop` 统一 `defer { activePromptTask = nil }`。
- 结果：状态管理更单点，降低 prompt 状态漂移风险。

## 测试稳定性修正
- `testPendingMessagesCanIncludeResolvedHistory` 存在 task 调度先后竞争。
- 调整为先短暂 sleep 再提交 follow-up，确保首个 prompt 已进入运行态，避免与本用例目标无关的竞态噪声。

## 测试稳定性策略：外部 Provider 用例默认关闭
- 问题：`swift test` 曾因第三方服务状态、API key、图片 URL 可用性波动产生非代码回归失败。
- 决策：对外部依赖测试统一引入 `RUN_LIVE_PROVIDER_TESTS=1` 显式开关，默认关闭 live 调用。
- 覆盖文件：`TavilySearchTest.swift`、`MedicalReportTests.swift`、`GameTests.swift`。
- 验证：默认环境执行 `swift test` 全绿（248 tests, 1 skipped, 0 failures）。

## Swift 6 并发警告清理（GameTests）
- 调整 `GameTests` 中 `SKITool` 测试实现的可变存储属性为只读（`name/description/npcDatabase/quests` 使用 `let`）。
- 目标：避免 `Sendable` 类型的 mutable stored property 警告，提升 Swift 6 兼容性。
- 验证：`swift test --filter GameTests` 无 warning/error，测试通过。

## SKIAgentSession 取消后 pending 失败历史补齐
- TDD：新增 `testCancelActivePromptMarksQueuedPendingAsFailedInHistory`，先红灯复现（取消后无 failed 历史）。
- 实现：`failPendingPrompts(with:)` 清空队列时，除了恢复 awaiting continuation，还为 awaiting/fire-and-forget 两类 pending 统一写入 `failed` 到 resolved history。
- 价值：`pendingMessages(includeResolved: true)` 在取消路径下具备一致可观测性，便于 UI/调试回放。
- 验证：
  - `swift test --filter SKIAgentSessionTests/testCancelActivePromptMarksQueuedPendingAsFailedInHistory` 通过。
  - `swift test --filter SKIAgentSessionTests --filter ACPAgentServiceTests` 通过。

## SKIAgentSession resolved pending history 上限裁剪测试
- 新增用例：`testResolvedPendingHistoryLimitKeepsLatestFailedItems`。
- 场景：活动 prompt 执行期间顺序入队 25 条 `followUp`，随后取消活动 prompt。
- 验证：
  - `pendingMessages(includeResolved: true)` 仅保留 20 条；
  - 全部为 `failed + follow_up`；
  - 头部裁剪后保留 `queued-05 ... queued-24`（顺序稳定）。
- 稳定性处理：避免并发 task 入队导致顺序抖动，改为 actor 内顺序 `followUp()` 入队。
- 回归：`swift test --filter SKIAgentSessionTests --filter ACPAgentServiceTests` 通过。

## pendingMessages includeResolved 预览长度一致性修复
- TDD：新增 `testPendingMessagesIncludeResolvedHonorsCustomPreviewMaxLength`，复现 resolved 历史未按 `maxLength` 截断问题。
- 实现：`pendingMessages(maxLength:includeResolved:)` 在 `includeResolved=true` 时，对 resolved 历史同样执行统一 `truncatePreview`。
- 同步重构：`promptPreview` 复用 `truncatePreview`，减少截断逻辑分叉。
- 验证：新增用例与 `SKIAgentSession + ACPAgentService` 回归通过。

## resolved pending history 容量裁剪稳态化
- 新增 `testResolvedPendingHistoryLimitKeepsLatestFailedItems`，验证上限 20 与从头裁剪顺序。
- 稳态处理：入队方式改为顺序 `followUp()`，避免并发 task 调度导致测试顺序抖动。

## SKIAgentSession 空闲态 fire-and-forget 历史一致性补齐
- 问题：`followUp/steer` 在空闲态直接执行时，原实现不会进入 pending 队列，因此执行完成后也不会写入 resolved/failed 历史，和“运行中排队”路径行为不一致。
- TDD：新增两条用例并先红灯复现：
  - `testFollowUpWhenIdleAppendsResolvedHistory`
  - `testFollowUpWhenIdleFailureAppendsFailedHistory`
- 实现：在 `enqueueFireAndForget` 的空闲分支，对启动 prompt 的执行结果补写历史：成功写 `resolved`，失败写 `failed`；并增加后台 drain，避免 fire-and-forget task 抛错无人消费。
- 规格同步：`docs-dev/features/SKIAgentSession-Spec.md` 新增场景 19（空闲态 fire-and-forget resolved/failed 历史一致性）。
- 验证：`swift test --filter SKIAgentSessionTests --filter ACPAgentServiceTests` 全绿。

## SKIAgentSession 非法 fork 索引与 idle steer 历史对齐
- 新增 TDD 用例：
  - `testForkFromInvalidUserEntryIndexThrowsDomainError`
  - `testSteerWhenIdleAppendsResolvedHistory`
  - `testSteerWhenIdleFailureAppendsFailedHistory`
- 发现并修复编译缺口：为 `SKIAgentSessionError` 补充 `Equatable` 以支持错误断言。
- 结果：
  - 非法索引 fork 统一映射到业务域错误 `invalidForkEntryIndex`；
  - 空闲态 `steer` 与 `followUp` 在成功/失败路径都能落 `resolved/failed` 历史，行为一致。
- 规格同步：`SKIAgentSession-Spec.md` 新增场景 20，并在场景 19 明确 `steer` 同步约束。
- 验证：`swift test --filter SKIAgentSessionTests --filter ACPAgentServiceTests` 全绿（77 passed）。

## SKIAgentSession fork 运行态隔离与清理用例稳态化
- 新增 TDD 用例：
  - `testForkDoesNotCopyQueuedPendingState`
  - `testForkDoesNotCopyResolvedPendingHistory`
- 语义锁定：`fork()` 仅复制 transcript 快照，不复制父会话 pending 队列或 resolved/failed 历史。
- 回归中暴露既有竞态：`testClearPendingStateCancelsQueuedFollowUpContinuations` 偶发未入队。
- 稳态化修正（测试侧）：在提交 queued follow-up 前增加短暂等待确保首个 prompt 进入运行态，并延长等待窗口（300ms -> 600ms）。
- 验证：`SKIAgentSession + ACPAgentService` 回归通过。

## SKIAgentSession fork 非 user index 错误语义补齐
- 新增用例 `testForkFromNonUserEntryIndexThrowsDomainError`，覆盖“索引存在但命中非 user entry”路径。
- 断言与不存在索引保持一致：统一映射为 `SKIAgentSessionError.invalidForkEntryIndex(index)`。
- 同步更新规格文字，明确非法 fork 包含“命中非 user entry”的情况。
- 验证：`swift test --filter SKIAgentSessionTests --filter ACPAgentServiceTests` 全绿（80 passed）。

## SKIAgentSession fork 后工具注册隔离补齐
- 新增用例：
  - `testForkToolRegistryIsolationParentUnregisterDoesNotAffectChild`
  - `testForkToolRegistryIsolationChildUnregisterDoesNotAffectParent`
- 语义锁定：fork 后父子会话工具注册表互不影响；一侧 `unregister(toolNamed:)` 不应污染另一侧。
- 验证：`swift test --filter SKIAgentSessionTests --filter ACPAgentServiceTests` 全绿。

## ACP 端到端契约矩阵首批落地
- 新增测试文件：`ACPDomainE2EMatrixTests.swift`。
- 采用同一契约跑两条 transport：
  - `stdioInProcess`（内存双端 transport）
  - `wsInProcess`（WebSocket client/server transport）
- 首批覆盖：
  - 权限拒绝契约：`session/prompt` -> `stopReason=cancelled`
  - 会话域链路契约：`session/new -> prompt -> fork -> load -> export`
- 回归结果：
  - `swift test --filter ACPDomainE2EMatrixTests` 通过
  - `swift test --filter ACPAgentServiceTests --filter ACPClientServiceTests --filter ACPDomainE2EMatrixTests` 通过
- 风险备注：`fork` 后再次 `prompt` 的跨 transport 契约在矩阵中暂未启用（曾触发 `prompt_fork` 参数解码错误），后续单独排查后补回矩阵。

## ACP 端到端契约矩阵补强（initialize/authenticate + session/list）
- TDD：先在 `ACPDomainE2EMatrixTests` 新增两条跨 transport 契约测试（stdio/ws 同跑）：
  - `testInitializeAuthenticateContractConsistentBetweenStdioAndWebSocket`
  - `testSessionListContractConsistentBetweenStdioAndWebSocket`
- 实现侧最小变更：矩阵 harness 新增可选 authMode（none/token），用于覆盖 `initialize -> authenticate` 真实链路。
- 契约结果：
  - `initialize` 返回 `protocolVersion=1` 与 `authMethods=[token]` 在 stdio/ws 一致。
  - `session/new x3 + session/list(cursor)` 可完整枚举创建会话且无重复，在 stdio/ws 一致。
- 回归验证：
  - `swift test --filter ACPDomainE2EMatrixTests` 通过（9/9）。
  - `swift test --filter ACP --filter SKICLITests` 通过（141 passed, 1 skipped）。
- 文档同步：`docs-dev/dev/testing-strategy.md` 已更新矩阵覆盖项，移除 fork prompt 缺口描述（已实测纳入）。

## ACP 端到端契约矩阵补强（set_model/load + session_cancel）
- TDD 扩展：在 `ACPDomainE2EMatrixTests` 新增两条跨 transport（stdio/ws）契约：
  - `testSetModelLoadContractConsistentBetweenStdioAndWebSocket`
  - `testSessionCancelPromptContractConsistentBetweenStdioAndWebSocket`
- `set_model/load` 契约：`session/set_model(gpt-5)` 后执行 `session/load`，再 `session/resume` 读取状态，`currentModelId` 与可用模型集在 stdio/ws 一致。
- 取消契约：引入慢响应 `SlowMatrixClient` 以稳定制造 in-flight prompt，验证 `session/cancel` 在 stdio/ws 都返回 `stopReason=cancelled`。
- 回归验证：
  - `swift test --filter ACPDomainE2EMatrixTests` 通过（11/11）。
  - `swift test --filter ACP --filter SKICLITests` 通过（143 passed, 1 skipped）。
- 文档同步：`docs-dev/dev/testing-strategy.md` 已增加上述两条矩阵契约描述。

## ACP 矩阵推进（本轮补强与收口）
- 新增并稳定通过 `ACPDomainE2EMatrixTests` 契约：
  - `testSetModelLoadContractConsistentBetweenStdioAndWebSocket`
  - `testSessionCancelPromptContractConsistentBetweenStdioAndWebSocket`
- 尝试补入 `$/cancel_request` 的 transport E2E 矩阵时，出现与 service 层单测不一致（E2E 下 prompt 最终返回非 rpcError）。
- 收口决策：暂不纳入该矩阵用例，先保持回归绿灯；将该项记录为“待收敛项”，当前由 `ACPAgentServiceTests/testPromptCanBeCancelledByProtocolCancelRequest` 保障协议语义。
- 回归状态：`swift test --filter ACP --filter SKICLITests` 通过（143 passed, 1 skipped）。

## ACP `$/cancel_request` 竞态修复（服务层）
- 问题：当 `$/cancel_request` 先于 prompt request 注册映射到达，或发生在权限请求阶段时，原实现可能丢失取消信号。
- 实现：`ACPAgentService` 新增 `pendingProtocolCancelledRequestIDs`，并在 `session/prompt` 入口与权限后运行前双重检查，确保“先取消后到达”的请求仍返回 `requestCancelled`。
- 取消处理增强：`handleCancel($/cancel_request)` 在找不到映射时先缓存 requestId，而不是直接丢弃。
- TDD：新增 `ACPAgentServiceTests/testPromptCanBeCancelledByProtocolCancelRequestDuringPermissionStage`，验证权限阶段也能收到 `requestCancelled`。
- 现状：service 层契约通过；transport E2E 下 `$/cancel_request` 仍存在 ws 路径不稳定，已继续标记为待收敛项。

## ACP `$/cancel_request` 继续推进（transport 基础能力）
- 在 `ACPAgentService` 增加 requestId 竞态回退机制：支持 `int <-> s2c-*` 双向候选匹配，避免 ws 内部重写/时序导致取消信号丢失。
- 在 `WebSocketServerTransport` 增加入站通知重写能力：对 `$/cancel_request` 的 `requestId` 尝试从原始 id 映射到内部 id。
- 新增服务层回归仍保持通过：`testPromptCanBeCancelledByProtocolCancelRequest` 与 `testPromptCanBeCancelledByProtocolCancelRequestDuringPermissionStage`。
- 当前结论：service 契约已稳；`$/cancel_request` 端到端矩阵断言暂未重新纳入，继续作为待收敛项。
- 回归：`swift test --filter ACP --filter SKICLITests` 全绿（144 passed, 1 skipped）。

## ACP `$/cancel_request` E2E 矩阵收口
- 新增 `ACPDomainE2EMatrixTests/testCancelRequestPromptContractConsistentBetweenStdioAndWebSocket`，直接走原始 JSON-RPC（request + notification）验证协议级取消。
- 用例链路：`initialize -> session/new -> session/prompt(in-flight) -> $/cancel_request`。
- 结果：stdio/ws 两条链路都稳定返回 `JSONRPCErrorCode.requestCancelled`。
- 说明：此前文档中的“`$/cancel_request` E2E 待收敛项”已关闭。

## 本轮回归结论
- 通过：`swift test --filter ACPDomainE2EMatrixTests/testCancelRequestPromptContractConsistentBetweenStdioAndWebSocket`
- 通过（局部失败后复验）：`swift test --filter ACPClientRuntimeTests/testProcessTerminalRuntimeLifecycle`
- 观察：`swift test --filter ACP` 全量中出现一次 `ACPClientRuntimeTests/testProcessTerminalRuntimeLifecycle` 波动失败，复跑通过，暂记稳定性观察项。

## ACP `$/cancel_request` 权限阶段矩阵补齐
- 新增 `ACPDomainE2EMatrixTests/testCancelRequestDuringPermissionContractConsistentBetweenStdioAndWebSocket`。
- 覆盖场景：prompt 发起后进入 `session/request_permission` 等待窗口，此时发送 `$/cancel_request`。
- 结果：stdio/ws 均稳定返回 `JSONRPCErrorCode.requestCancelled`，与服务层竞态语义一致。
- 回归：`swift test --filter ACPDomainE2EMatrixTests` 13/13 全绿。

## ACP Runtime 输出竞态收口
- 修复 `ACPProcessTerminalRuntime`：在 `markExit` 中关闭 `readabilityHandler` 后主动 `readDataToEndOfFile()`，确保进程退出时尾部输出被并入缓冲。
- 新增回归 `testProcessTerminalRuntimeWaitForExitFlushesRemainingOutput`，校验 `waitForExit` 后可稳定读取完整输出。
- 回归状态：
  - `swift test --filter ACPClientRuntimeTests` 通过
  - `swift test --filter ACP --filter SKICLITests` 通过（149 passed, 1 skipped）

## ACP `$/cancel_request` 字符串 requestId 覆盖补齐
- 新增矩阵：`testCancelRequestPromptWithStringRequestIDContractConsistentBetweenStdioAndWebSocket`。
- 新增 ws routing：`testCancelRequestNotificationStringRequestIDIsRemappedToInternalID`。
- 结果：字符串 requestId 在 stdio/ws 全链路都可稳定触发 `requestCancelled`。
- 回归：`swift test --filter ACP --filter SKICLITests` 通过（151 passed, 1 skipped）。

## ACP ws 多客户端并发压力增强
- 新增 `ACPWebSocketMultiClientTests/testFiveClientsCanPromptConcurrentlyWithoutCrossRouting`（5 客户端并发 prompt）。
- 断言：每个客户端都得到 `stopReason=endTurn`，且仅命中自身 `multi: hello-i` 更新文本。
- 全量回归：`swift test --filter ACP --filter SKICLITests` 通过（152 passed, 1 skipped）。

## ACP `cancel_request` fallback 双向预取消回归
- 新增两条服务层用例，覆盖 `string("s2c-N") -> int(N)` 与 `int(N) -> string("s2c-N")` 双向映射。
- 场景：`$/cancel_request` 先到、`session/prompt` 后到，最终都返回 `requestCancelled`。
- 回归：`swift test --filter ACP --filter SKICLITests` 通过（154 passed, 1 skipped）。

## ACP pre-cancel 跨 transport 矩阵补齐
- 新增 `testPreCancelRequestPromptContractConsistentBetweenStdioAndWebSocket`。
- 覆盖 `cancel_request` 先到后 prompt 的两种 fallback 方向（string->int / int->string）。
- 结果：stdio/ws 都返回 `requestCancelled`，并发回归仍全绿。
- 回归：`swift test --filter ACP --filter SKICLITests` 通过（155 passed, 1 skipped）。

## ACP ws client runtime E2E 收口
- 新增 `ACPWebSocketClientRuntimeRoundtripTests`，补齐 agent->client `fs/*` 与 `terminal/*` 的真实 WebSocket 回调链路。
- 覆盖关键场景：
  - `fs/read_text_file` + `fs/write_text_file`。
  - `terminal/create/output/wait_for_exit/release`。
  - `terminal/kill` 后 `output` 仍可读，`release` 后 terminalId 失效。
- 关键实现决策：测试侧不再使用 mock initialize server，而是走 `ACPAgentService + session/new` 建立 ws `sessionId -> owner connection` 路由，避免 server->client request 无 owner 导致不可路由。
- 回归结果：`swift test --filter ACPWebSocketClientRuntimeRoundtripTests` 与 `swift test --filter ACP --filter SKICLITests` 全绿（159 passed, 1 skipped）。

## ACP runtime 跨 transport 矩阵收口
- 将 client runtime 回调能力正式纳入 `ACPDomainE2EMatrixTests`，不再仅依赖单链路 ws 用例。
- 新增两条矩阵契约：
  - `testRuntimeFSAndTerminalLifecycleContractConsistentBetweenStdioAndWebSocket`
  - `testRuntimeTerminalKillContractConsistentBetweenStdioAndWebSocket`
- 关键覆盖：`fs/read|write`、`terminal/create|wait_for_exit|output|kill|release`，以及 release 后 terminalId 失效语义。
- 基础设施决策：给 `InProcessMatrixHarness` 加 `onResponse` 回调，统一捕获 server->client request 响应做跨 transport 对比。
- 回归：`swift test --filter ACP --filter SKICLITests` 全绿（161 passed, 1 skipped）。

## ACP 规格映射收口
- 补充了 `ACP-WebSocket-Serve-Spec` 到测试集的映射清单（已覆盖/部分覆盖/待补）。
- 新增缺口结论：当前无阻塞级别缺口，剩余建议项是“permission bridge 真实断链时序 E2E”与“stdio CLI 进程级不变性快照”。
- 本轮新增测试：
  - `ACPWebSocketTestHarnessTests/testServerSendWithoutConnectedClientReturnsNotConnected`
  - `ACPPermissionRequestBridgeTests/testFailAllClearsPendingPermissionRequests`
- 全量回归：`swift test --filter ACP --filter SKICLITests` 通过（163 passed, 1 skipped）。

## ACP permission 断链快失败补强
- 新增 `ACPWebSocketPermissionRoundtripTests/testPendingPermissionRequestFailsFastWhenTransportCloses`。
- 场景：`session/request_permission` 挂起时关闭 ws transport，并执行 bridge `failAll` 清理。
- 断言：`session/prompt` 快速失败（EOF/notConnected/rpcError），不发生 timeout 挂死。
- 全量回归：`swift test --filter ACP --filter SKICLITests` 通过（164 passed, 1 skipped）。

## A 批次落地：ACP 门禁资产化
- 新增 stdio 真实进程级不变性测试：`SKICLIProcessTests/testClientConnectViaStdioServeProcessSucceeds`。
- 新增覆盖矩阵文档：`docs-dev/dev/ACP-Spec-Coverage-Matrix.md`（spec 场景 -> 测试映射）。
- 新增覆盖矩阵守卫：`ACPSpecCoverageMatrixTests`，校验文档中测试引用与文件路径可解析存在。
- 新增一键门禁脚本：`scripts/test_acp_gate.sh`。
- 全量门禁回归：`./scripts/test_acp_gate.sh` 通过（182 passed, 1 skipped）。

## 22:54 Codex CLI 体验闭环（Round 1 + Round 2）
- 决策：`ski acp client connect` 对 `--prompt` 增加非空白校验；空输入直接返回 invalidInput（exit code 2），避免把输入错误伪装成上游失败。
- 决策：`connect --help` 增加 stdio/ws 可复制示例，降低首次接入成本。
- 决策：`--permission-message` 目前不进入 ACP 协议负载，CLI 改为显式 warning，避免“静默无效”误判。
- 验证：新增并通过 `SKICLIProcessTests` 3 个进程级用例；`./scripts/test_acp_gate.sh` 全通过（185 passed, 1 skipped, 0 failed）。

## 23:00 Codex CLI 体验闭环（Round 3）
- 决策：CLI 层新增输入参数显式校验，拒绝“静默修正/延迟到上游失败”的 DX 模式。
- 新增校验：
  - `client connect`：`--cwd` 必须是已存在目录；`--request-timeout-ms/--ws-heartbeat-ms/--ws-reconnect-attempts/--ws-reconnect-base-delay-ms >= 0`；`--max-in-flight-sends > 0`。
  - `serve`：`--prompt-timeout-ms/--session-ttl-ms/--permission-timeout-ms >= 0`；`--max-in-flight-sends > 0`。
- 测试：新增 `SKICLIProcessTests` 3 条进程级用例并通过。
- 回归：`./scripts/test_acp_gate.sh` 全通过（188 passed, 1 skipped, 0 failed）。

## 23:03 Codex CLI 体验闭环（Round 4）
- 决策：ws endpoint 输入升级为协议级校验（必须 `ws/wss` 且 host 非空），避免把参数错误延迟为连接失败。
- 决策：stdio `--cmd` 增加非空白校验，空字符串直接 invalidInput（exit code 2）。
- 新增测试：
  - `SKICLIProcessTests/testClientRejectsEndpointWithoutWSScheme`
  - `SKICLIProcessTests/testClientRejectsEndpointWithoutHost`
  - `SKICLIProcessTests/testClientConnectRejectsEmptyCmdForStdio`
- 回归：`./scripts/test_acp_gate.sh` 全通过（191 passed, 1 skipped, 0 failed）。
- 风险备注：`codex exec` 仍有 `refresh_token_reused` 日志噪音，后续建议先做一次 codex re-login 清理认证状态。

## 23:06 Codex CLI 体验闭环（Round 5）
- 决策：收敛 transport 互斥参数，禁止“参数可传但被静默忽略”的行为。
- 新增互斥约束：
  - `client connect`：`ws` 禁止 `--cmd/--args`；`stdio` 禁止 `--endpoint`。
  - `serve`：`stdio` 禁止覆盖 `--listen`。
- 新增测试：
  - `SKICLIProcessTests/testClientWSRejectsCmdOption`
  - `SKICLIProcessTests/testClientStdioRejectsEndpointOption`
  - `SKICLIProcessTests/testServeStdioRejectsListenOverride`
- 回归：`./scripts/test_acp_gate.sh` 全通过（194 passed, 1 skipped, 0 failed）。

## 23:09 Codex CLI 体验闭环（Round 6）
- 决策：在 stdio transport 下彻底禁止 ws 专属调参，消除“可传但无效”的静默行为。
- 新增互斥约束：`client connect --transport stdio` 下禁止 `--ws-heartbeat-ms`、`--ws-reconnect-attempts`、`--ws-reconnect-base-delay-ms` 偏离默认值。
- 新增测试：
  - `SKICLIProcessTests/testClientStdioRejectsWSHeartbeatOption`
  - `SKICLIProcessTests/testClientStdioRejectsWSReconnectAttemptsOption`
  - `SKICLIProcessTests/testClientStdioRejectsWSReconnectBaseDelayOption`
- 回归：`./scripts/test_acp_gate.sh` 全通过（197 passed, 1 skipped, 0 failed）。

## 23:13 Codex CLI 体验闭环（Round 7）
- 决策：继续收口 stdio 场景中的 ws 专属参数，禁止 `--max-in-flight-sends` 在 stdio 下被覆盖，避免“可传但无效”。
- 代码变更：
  - `ACPClientConnectCommand`：`stdio` 且 `--max-in-flight-sends != 64` 时返回 invalidInput。
  - `ACPServeCommand`：`stdio` 且 `--max-in-flight-sends != 64` 时返回 invalidInput。
- 测试变更：
  - 新增 `SKICLIProcessTests/testClientStdioRejectsMaxInFlightSendsOption`
  - 新增 `SKICLIProcessTests/testServeStdioRejectsMaxInFlightSendsOverride`
  - 调整 `SKICLIProcessTests/testServeRejectsInvalidMaxInFlightSends` 到 ws 场景。
- 回归：
  - 定向红绿：3 条进程级用例先红后绿。
  - 全量门禁：`./scripts/test_acp_gate.sh` 通过（199 passed, 1 skipped, 0 failed）。

## 23:20 Codex CLI 体验闭环（Round 8）
- 决策：把 ws 专属参数互斥从“默认值比较”升级为“显式传参拦截”，彻底消除默认值绕过。
- 代码变更：
  - `ACPClientConnectCommand` 与 `ACPServeCommand` 新增 `hasExplicitOption` 检测逻辑，`stdio` 下显式传 `--listen` / `--ws-*` / `--max-in-flight-sends` 统一报 `invalidInput`。
  - `client connect` 的 `--cwd` 本地目录校验限制为 `transport == stdio`，`ws` 下不再做本地存在性强校验。
- 测试变更（先红后绿）：
  - 新增 `testClientStdioRejectsWSHeartbeatOptionEvenWhenDefaultProvided`
  - 新增 `testServeStdioRejectsListenOptionEvenWhenDefaultProvided`
  - 新增 `testServeStdioRejectsMaxInFlightSendsOptionEvenWhenDefaultProvided`
  - 新增 `testClientWSDoesNotRequireLocalCWDExistence`
- 回归：
  - 定向进程级测试 4 条全部通过。
  - 全量门禁：`./scripts/test_acp_gate.sh` 通过（203 passed, 1 skipped, 0 failed）。

## 23:42 Codex CLI 体验闭环（Round 9）
- 决策：优化 CLI 报错优先级与误解析提示，提升“出错后第一跳”诊断质量。
- 代码变更：
  - `ACPClientConnectCommand` 先做 transport 作用域校验，再做 ws 参数数值范围校验（避免 stdio 场景出现误导性范围错误）。
  - 在 `transport=ws + cmd + --args` 组合下，增强错误提示，给出 `--args=--flag` 的可执行建议。
- 测试变更（先红后绿）：
  - 新增 `testClientStdioWsOnlyOptionPrioritizesTransportScopeErrorOverRangeError`
  - 新增 `testClientArgsOptionLikeTokenShowsHint`
- 回归：
  - 定向新增测试 2 条通过。
  - 全量门禁：`./scripts/test_acp_gate.sh` 通过（205 passed, 1 skipped, 0 failed）。

## 23:48 Codex CLI 体验闭环（Round 10）
- 决策：收口帮助文档层面的语义偏差，确保 `--help` 与运行时行为一致。
- 代码变更：
  - `ACPClientConnectCommand` 的示例改为 `--args` + `--args=--flag` 混合写法，避免 option-like 子参数被父命令误解析。
  - 增加 `Note` 明确 child args 传递规则。
  - `--permission-message` help 改为“仅本地提示，不发送到 ACP server”。
- 测试变更（先红后绿）：
  - 新增 `testClientConnectHelpExamplesUseArgsEqualsForOptionLikeChildArgs`
  - 新增 `testClientConnectHelpMarksPermissionMessageAsInformationalOnly`
- 回归：
  - 定向新增测试 2 条通过。
  - 全量门禁：`./scripts/test_acp_gate.sh` 通过（207 passed, 1 skipped, 0 failed）。
