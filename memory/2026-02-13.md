# 2026-02-13

## ACP 业务域收口（Runtime + Session Persistence）
- 决策：将 FS/Terminal 运行时从 CLI 内嵌实现上提为 `SKIACPClient` 可复用抽象，避免 CLI 与协议处理层耦合。
- 新增：
  - `ACPFilesystemRuntime`、`ACPLocalFilesystemRuntime`（含 rooted 访问策略）
  - `ACPTerminalRuntime`、`ACPProcessTerminalRuntime`
  - `ACPClientService.installRuntimes(filesystem:terminal:)`
- 新增：`SKIAgentSession.enableJSONLPersistence(fileURL:configuration:)`，用于跨 session transcript 恢复。
- 验证：`ACPClientRuntimeTests` + `SKIAgentSession` 持久化测试通过；ACP/CLI 相关回归通过。
- 风险：rooted 路径策略当前基于标准化路径与前缀判断，复杂符号链接场景需后续补充更严格 realpath 校验。

## Permission Policy 语义收敛（追加）
- 决策：记忆命中 `reject_always` 时统一返回 `cancelled`，降低上层分支处理复杂度。
- 新增测试：
  - `testPolicyAskModeRemembersRejectAlwaysAndShortCircuitsToCancelled`
  - `testPolicyAskModeDoesNotRememberAllowOnce`
- 回归：`ACPPermissionPolicyTests` 与 ACP agent/session 子集回归通过。

## ACP Session Fork 语义（追加）
- 决策：`session/fork` 必须复制源会话 transcript，而不是创建空会话后仅复制 metadata。
- 实现：在 `ACPAgentSession` 增加 snapshot/restore 协议能力，`ACPAgentService` 在 fork 时执行 snapshot->factory->restore。
- 验证：新增 `testForkCopiesSessionStateAndKeepsIsolation`，确认 fork 继承上下文且源/分叉互不污染。

## ACP Session Load 持久化恢复（追加）
- 决策：`session/load` 在内存缺失场景下，应优先尝试从 JSONL 落盘恢复（仅在显式配置持久化目录时启用）。
- 实现：
  - `ACPAgentService.Options` 新增 `sessionPersistence(directoryURL, configuration)`。
  - `ACPAgentService` 在 `session/new`/`session/fork` 自动绑定 `<sessionId>.jsonl`。
  - `ACPAgentService.sessionLoad` 内存 miss 时，若磁盘文件存在则自动创建并恢复 session。
  - 新增 `ACPPersistableAgentSession`，由 `SKIAgentSession` 对接 JSONL 持久化能力。
- 验证：`testSessionLoadRestoresPersistedTranscriptWhenSessionNotInMemory` 与 ACP 子集回归通过。

## ACP Prompt 执行状态机（A1+A3 第一批）
- 决策：执行状态更新采用“默认关闭、按选项开启”的兼容策略，避免影响现有 client 的 update 序列假设。
- 实现：
  - `ACPSessionUpdateKind` 新增 `execution_state_update`（并预留 `retry_update/audit_update`）。
  - `ACPAgentService.Options` 新增 `promptExecution.enableStateUpdates`。
  - `session/prompt` 在开启时发射 `queued/running/completed/cancelled/timed_out/failed`。
- 测试：
  - `testExecutionStateUpdateRoundTrip`
  - `testPromptEmitsExecutionStateLifecycleWhenEnabled`
  - `testPromptCancellationEmitsExecutionStateWhenEnabled`
  - ACP 子集回归通过（含 `ACPTransportConsistencyTests`）。

## ACP Prompt 重试策略（A2）
- 决策：重试能力默认关闭（`maxRetries=0`），显式配置后启用，避免影响现网语义。
- 实现：
  - `PromptExecution` 增加 `maxRetries` 与 `retryBaseDelayNanoseconds`。
  - 非取消/非超时错误进入重试；取消与超时保持立即终止语义。
  - 重试中发射 `retry_update` 与 `execution_state_update(retrying)`。
  - 重试耗尽发射 `execution_state_update(failed)`。
- 测试：
  - `testPromptRetriesThenSucceedsWhenConfigured`
  - `testPromptRetryExhaustedReturnsInternalError`
  - `testRetryUpdateRoundTrip`
  - ACP 子集回归通过。

## ACP FS Policy 细化（B1 第一批）
- 决策：保持现有 `rooted` 兼容，新增 `rootedWithRules` 作为增强策略入口。
- 实现：
  - 新增 `ACPFilesystemRootedRules(readOnlyRoots, deniedPathPrefixes)`。
  - 访问校验顺序：root 边界 -> deny prefix -> write 时 read-only roots。
- 测试：
  - `testLocalFilesystemRuntimeRootedRulesReadOnlyAndDeniedPrefixes`
  - ACP 子集回归通过。

## ACP Terminal Policy 细化（B2 第一批）
- 决策：终端策略先做命令白黑名单和超时终止，保持默认策略为“兼容放行”。
- 实现：
  - `ACPProcessTerminalRuntime.Policy`：`allowedCommands/deniedCommands/maxRuntimeNanoseconds`。
  - create 前命令校验，不满足策略返回 `commandDenied`。
  - 超时自动 terminate，`wait_for_exit` 可及时结束。
- 测试：
  - `testProcessTerminalRuntimeRejectsDeniedCommand`
  - `testProcessTerminalRuntimeTerminatesWhenExceedingMaxRuntime`
  - ACP 子集回归通过。

## ACP Agent Telemetry + Golden 收口（追加）
- 决策：telemetry 作为非 ACP 标准扩展，仅提供 `ACPAgentService` 内部 sink 注入，不新增协议方法。
- 实现：
  - 新增 `ACPAgentTelemetryEvent` 与 `telemetrySink`；
  - 覆盖 session/prompt/retry 关键生命周期事件；
  - 补齐 golden fixtures：`execution_state_update`、`retry_update`。
- 测试：
  - `testPromptEmitsTelemetryLifecycle`
  - `testPromptRetryEmitsTelemetryRetryEvent`
  - `testSessionUpdateGoldenFixturesRoundTrip`
  - ACP 子集回归通过（`ACPModels/AgentService/ClientRuntime/Golden/TransportConsistency`）。

## Telemetry 协议边界标记（追加）
- 决策：在源码与规格文档中显式标注“协议域 vs 扩展域”，避免后续将 telemetry 混入 ACP payload。
- 必要性：保障 ACP 兼容稳定，同时保留工程观测能力（重试/权限/失败分支可追踪）。
