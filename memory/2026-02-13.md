# 2026-02-13

## ACP 业务域收口（Runtime + Session Persistence）
- 决策：将 FS/Terminal 运行时从 CLI 内嵌实现上提为 `SKIACPClient` 可复用抽象，避免 CLI 与协议处理层耦合。
- 新增：
  - `ACPFilesystemRuntime`、`ACPLocalFilesystemRuntime`（含 rooted 访问策略）
  - `ACPTerminalRuntime`、`ACPProcessTerminalRuntime`
  - `ACPClientService.installRuntimes(filesystem:terminal:)`
- 新增：`SKIAgentSession.enableJSONLPersistence(fileURL:configuration:)`，用于跨 session transcript 恢复。
- 验证：`ACPClientRuntimeTests` + `SKIAgentSession` 持久化测试通过；ACP/CLI 相关回归通过。
- 风险：rooted 路径策略当前基于标准化路径与前缀判断，复杂符号链接场景需后续补充更严格 realpath 校验。

## Permission Policy 语义收敛（追加）
- 决策：记忆命中 `reject_always` 时统一返回 `cancelled`，降低上层分支处理复杂度。
- 新增测试：
  - `testPolicyAskModeRemembersRejectAlwaysAndShortCircuitsToCancelled`
  - `testPolicyAskModeDoesNotRememberAllowOnce`
- 回归：`ACPPermissionPolicyTests` 与 ACP agent/session 子集回归通过。

## ACP Session Fork 语义（追加）
- 决策：`session/fork` 必须复制源会话 transcript，而不是创建空会话后仅复制 metadata。
- 实现：在 `ACPAgentSession` 增加 snapshot/restore 协议能力，`ACPAgentService` 在 fork 时执行 snapshot->factory->restore。
- 验证：新增 `testForkCopiesSessionStateAndKeepsIsolation`，确认 fork 继承上下文且源/分叉互不污染。
